<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml">
	<head>
		<title>PA UI Mod Manager</title>
		<HTA:APPLICATION ID="PAMM" APPLICATIONNAME="PA UI Mod Manager" SCROLL="no" SINGLEINSTANCE="no" ICON="manager\img\favicon.ico">
		<link href="manager\pamm.css" rel="stylesheet" type="text/css">
	</head>

	<script type="text/javascript" src="manager\json3.min.js"></script>
	<script type="text/javascript" src="manager\jquery-1.10.2.min.js"></script>
	<script type="text/javascript" src="manager\locale.js"></script>
		
	<script type="text/javascript">	
		
		var objInstalledMods = [];
		var objOnlineMods = [];
		var objPAMMVersionData = {};
		var objOptions = {};
		var objOnlineModCategories = {};
		var objInstalledModCategories = {};
		
		var strCurrentPanel = "news";
		var boolAutoWrite = true;
		var boolOnline = true;
		var intDownloading = 0;
		var strModInstalling = "";
		var intLogLevel = 0;
		var intLogNumber = 0;
		var intLikeCountRemaining = 0;
		var intMessageID = 0;
		var commandlineSetIntervalID;
		
		var ONLINE_MODS_LIST_URL = "http://pamods.github.io/modlist.json";
		var ONLINE_MODS_DOWNLOAD_COUNT_URL = "http://pa.raevn.com/modcount_json.php";
		var MANAGE_URL = "http://pa.raevn.com/manage.php";
		var MOD_IS_NEW_PERIOD_DAYS = 7;
		var NEW_LINE = "\r\n";
		var NEWS_URL = "http://pamods.github.io/news.html";
		var PAMM_VERSION_DATA_URL = "http://pa.raevn.com/pammversion.json";
		var PAMM_MOD_ID = "rPAMM";
		var PAMM_OPTIONS_FILENAME = "pamm.json";
		var PAMM_ONLINE_TEST_URL = "http://pa.raevn.com/pamm_online.txt";
		var MOD_GENERIC_ICON_URL = "manager/img/generic.png";
		var PAMM_DEFAULT_LOCALE = "en";
		var strModsDirectoryPath = "";
		var strPAMMCacheDirectoryPath = "";
		
		//TODO: Read PA build number from uberent servers
		
		var datePAMM = "2014/04/30";
		var strPAMMversion = "4.0.4";
		var strPABuild = "64498";
		
		/* Localisation Functions */
		function jsGetLocaleText(strKey, strLocale) {
			if (strlocaleText[strKey] != null) {
				if (strlocaleText[strKey][strLocale] != null && strlocaleText[strKey][strLocale] != "") {
					return strlocaleText[strKey][strLocale];
				} else if (strlocaleText[strKey]["en"] != null) {
					return strlocaleText[strKey]["en"];
				}
			}
			return null;
		}
		
		function jsApplyLocaleText() {
			for (var i = 0; i < strLocaleTextItems.length; i++) {
				var objLocItems = $(".LOC_" + strLocaleTextItems[i]);
				if (objLocItems.length > 0) {
					if (objLocItems.prop("tagName") == "INPUT") {
						objLocItems.attr("value", jsGetLocaleText(strLocaleTextItems[i], objOptions["locale"]));
					} else {
						objLocItems.text(jsGetLocaleText(strLocaleTextItems[i], objOptions["locale"]));
					}
				}
			}
		}
		
		/* Sorting Functions */
		function sort_random(){
			return (Math.round(Math.random())-0.5);
		}
		
		function sort_by(field, reverse, primer) {
			var key = primer ? function(x) {return primer(x[field])} : function(x) {return x[field]};
			reverse = [-1, 1][+!!reverse];

			return function (a, b) {
				return a = key(a), b = key(b), reverse * ((a > b) - (b > a));
			} 
		}
		
		function jsSortOnlineMods() {
			switch (objOptions["sort"]) {
				case "LAST_UPDATED":
					objOnlineMods.sort(sort_by('date', false, function(x) { return new Date(x); } ));
					$("#filter_area_sort_last_updated").addClass('filter_area_filter_item_selected');
					break;
				case "TITLE":
					objOnlineMods.sort(sort_by('display_name', true, null));
					$("#filter_area_sort_last_title").addClass('filter_area_filter_item_selected');
					break;
				case "AUTHOR":
					objOnlineMods.sort(sort_by('author', true, null));
					$("#filter_area_sort_last_author").addClass('filter_area_filter_item_selected');
					break;
				case "BUILD":
					objOnlineMods.sort(sort_by('build', false, null));
					$("#filter_area_sort_last_build").addClass('filter_area_filter_item_selected');
					break;
				case "LIKES":
					objOnlineMods.sort(sort_by('likes', false, parseInt));
					$("#filter_area_sort_last_likes").addClass('filter_area_filter_item_selected');
					break;
				case "DOWNLOADS":
					objOnlineMods.sort(sort_by('downloads', false, parseInt));
					$("#filter_area_sort_last_downloads").addClass('filter_area_filter_item_selected');
					break;
				case "RANDOM":
					objOnlineMods.sort(sort_random);
					$("#filter_area_sort_last_random").addClass('filter_area_filter_item_selected');
					break;
			}
		}
		
		/* Data Strings */
		function jsGetInstalledModListDataString() {
			var strInstalledModsList = {};
			
			for (var i = 0; i < objInstalledMods.length; i++) {
				strInstalledModsList[objInstalledMods[i].id] = objInstalledMods[i]
			}
			return JSON.stringify(strInstalledModsList, null, 4).replace(/\r?\n/g, NEW_LINE);
		}
		
		function jsGetUIModListGlobalDataString() {
			var global_mod_list = [];
			objInstalledMods.sort(sort_by('priority', true, parseInt));
		
			for (var i = 0; i < objInstalledMods.length; i++) {
				if (objInstalledMods[i].enabled == true) {
					if (objInstalledMods[i]["global_mod_list"] != null) {
						for (var j = 0; j < objInstalledMods[i]["global_mod_list"].length; j++) {
							global_mod_list.push(objInstalledMods[i]["global_mod_list"][j]);
						}
					}
					if (objInstalledMods[i]["scenes"] != null && objInstalledMods[i]["scenes"]["global_mod_list"] != null) {
						for (var j = 0; j < objInstalledMods[i]["scenes"]["global_mod_list"].length; j++) {
							global_mod_list.push(objInstalledMods[i]["scenes"]["global_mod_list"][j]);
						}
					}
				}
			}
			return JSON.stringify(global_mod_list, null, 4).replace(/\r?\n/g, NEW_LINE);
		}
		
		function jsGetUIModListSceneDataString() {
			var scene_mod_list  = {"armory": [], "building_planets": [], "connect_to_game": [], "game_over": [], "icon_atlas": [], "live_game": [], "live_game_econ": [], "live_game_hover": [], "load_planet": [], "lobby": [], "matchmaking": [], "new_game": [], "replay_browser": [], "server_browser": [], "settings": [], "social": [], "special_icon_atlas": [], "start": [], "system_editor": [], "transit": []};
			objInstalledMods.sort(sort_by('priority', true, parseInt));
			
			for (var i = 0; i < objInstalledMods.length; i++) {
				if (objInstalledMods[i].enabled == true) {
					for(var scene in objInstalledMods[i]) {
						if (scene_mod_list[scene] != null) {
							for(var j = 0; j < objInstalledMods[i][scene].length; j++) {
								scene_mod_list[scene].push(objInstalledMods[i][scene][j]);
							}
						}
						if (scene == "scenes") {
							for(var subscene in objInstalledMods[i][scene]) {
								if (subscene != "global_mod_list") {
									if (scene_mod_list[subscene] == null) {
										scene_mod_list[subscene] = [];
									}
									for(var j = 0; j < objInstalledMods[i][scene][subscene].length; j++) {
										scene_mod_list[subscene].push(objInstalledMods[i][scene][subscene][j]);
									}
								}
							}
						}
					}
				}
			}
			return JSON.stringify(scene_mod_list, null, 4).replace(/\r?\n/g, "\r\n");
		}
		
		function jsGetInstalledModDataString(strModID) {
			if (jsGetInstalledMod(strModID) != null) { 
				return JSON.stringify(jsGetInstalledMod(strModID), null, 4).replace(/\r?\n/g, NEW_LINE);
			} else {
				return "";
			}
		}
		
		function jsGetModsJSONDataString() {
			var strOutput = {};
			strOutput["mount_order"] = [];
			
			objInstalledMods.sort(sort_by('priority', true, parseInt));
			
			for (var i = 0; i < objInstalledMods.length; i++) {
				if (objInstalledMods[i].enabled == true) {
					strOutput["mount_order"].push(objInstalledMods[i].identifier);
				}
			}
			return JSON.stringify(strOutput, null, 4).replace('\r\n', '\n').replace(/\r?\n/g, NEW_LINE);
		}
		
		/* Option Functions */
		function jsLoadOptionsData(strOptionsDataString) {
			objOptions = {};
			try {
				objOptions = JSON.parse(strOptionsDataString);
			} catch (err) {
				alert("An error occurred loading options file");
			}
			if (objOptions["pa_path"] == null) {
				objOptions["pa_path"] = "c:\\Program Files (x86)\\Planetary Annihilation\\PA\\PA.exe"
				if (CheckPAPresent(objOptions["pa_path"]) == false) {
					objOptions["pa_path"] = "C:\\Program Files (x86)\\Steam\\SteamApps\\common\\Planetary Annihilation\\PA.exe"
				}
			}
			
			var strPrompt = CheckPAPresent(objOptions["pa_path"]);
			
			while (strPrompt != null && strPrompt != true) {
				strPrompt = prompt("Could not find Planetary Annihilation. Please enter path to PA.exe", objOptions["pa_path"]);
				objOptions["pa_path"] = strPrompt;
				if (strPrompt != null) {
					strPrompt = CheckPAPresent(strPrompt);
				}
			}
			
			document.getElementById("setting_installLocation").value = objOptions["pa_path"];
			document.getElementById("setting_modLocation").value = strModsDirectoryPath;
			
			if (objOptions["debug"] != null) {
				document.getElementById("setting_debug").checked = objOptions["debug"];
			} else {
				document.getElementById("setting_debug").checked = false;
			}
			jsToggleDebugMode(true);
			
			if (objOptions["verbose"] != null) {
				document.getElementById("setting_verbose").checked = objOptions["verbose"];
			} else {
				document.getElementById("setting_verbose").checked = false;
			}
			jsToggleVerboseMode(true);
			
			if (objOptions["modlikes"] != null) {
				document.getElementById("setting_likes").checked = objOptions["modlikes"];
			} else {
				document.getElementById("setting_likes").checked = false;
			}
			jsToggleModLikes(true);
			
			if (objOptions["available_filter"] == null) {
				objOptions["available_filter"] = 'ALL';
			}
			
			if (objOptions["available_category"] == null) {
				objOptions["available_category"] = 'ALL';
			}			
			
			if (objOptions["installed_category"] == null) {
				objOptions["installed_category"] = 'ALL';
			}			
			
			if (objOptions["sort"] == null) {
				objOptions["sort"] = 'LAST_UPDATED';
			}
			
			if (objOptions["tab"] == null) {
				objOptions["tab"] = 'news';
			}
			document.getElementById('setting_defaultTab').value = objOptions["tab"];
			jsDisplayPanel(objOptions["tab"]);
			
			if (objOptions["locale"] != null) {
				document.getElementById('setting_language').value = objOptions["locale"];
				if (objOptions["locale"] != PAMM_DEFAULT_LOCALE) {
					jsSetLanguage(true);
				}
			}
			
			if (objOptions["available_view"] == null) {
				objOptions["available_view"] = 'detailed';
			}
			document.getElementById('setting_available_view').value = objOptions["available_view"];
			jsSetModsListView(false, true);
			
			if (objOptions["installed_view"] != null) {
				objOptions["installed_view"] = 'summary';
			}
			document.getElementById('setting_installed_view').value = objOptions["installed_view"];
			jsSetModsListView(true, true);
			
			if (objOptions["available_icon"] == null) {
				objOptions["available_icon"] = true;
			}
			document.getElementById('setting_available_icon').checked = objOptions["available_icon"];
			jsSetModsListIcon(false, true);
			
			if (objOptions["installed_icon"] == null) {
				objOptions["installed_icon"] = false;
			}
			document.getElementById('setting_installed_icon').checked = objOptions["installed_icon"];
			jsSetModsListIcon(true, true);
			
			if (objOptions["show_available_filters"] == null) {
				objOptions["show_available_filters"] = false;
			}
			jsUpdateOptionsToggle(false)

			if (objOptions["show_installed_filters"] == null) {
				objOptions["show_installed_filters"] = false;
			}
			jsUpdateOptionsToggle(true)
			
			document.getElementById("btnLaunch").disabled = strPrompt == null;
			WriteOptionsJSON();
		}
		
		function jsGetOptionsDataString() {
			return JSON.stringify(objOptions, null, 4).replace('\r\n', '\n').replace(/\r?\n/g, NEW_LINE)
		}
		
		function jsGetOption(strOption) {
			return objOptions[strOption];
		}
				
		/* Installed Mod Functions */
		function jsUpdateAll() {
			for (var i = 0; i < objInstalledMods.length; i++) {
				if (jsGetOnlineMod(objInstalledMods[i].id) != null && objInstalledMods[i].date < jsGetOnlineMod(objInstalledMods[i].id).date) {
					jsPreInstallMod(jsGetOnlineMod(objInstalledMods[i].id).url, objInstalledMods[i].id, {});
				}
			}
		}
			
		function jsLoadInstalledModData(strModID, strModDataString) {
			var objCurrentMod = {};
			try {
				objCurrentMod = JSON.parse(strModDataString);
				
				objCurrentMod["priority"] = objCurrentMod["priority"] ? objCurrentMod["priority"] : 100;
				if (objCurrentMod["enabled"] == null || strModID == PAMM_MOD_ID) {
					objCurrentMod["enabled"] = true;
				}
				objCurrentMod["id"] = strModID;
				
				
				if (objCurrentMod.category != null) {
					for (var i = 0; i < objCurrentMod.category.length; i++) {
						var strCurrentCategory = objCurrentMod.category[i].replace(" ", "-").toUpperCase();
						if (objInstalledModCategories[strCurrentCategory] == null) {
							objInstalledModCategories[strCurrentCategory] = 1;
						} else {
							objInstalledModCategories[strCurrentCategory]++;
						}
					}
				}
				
				objInstalledModCategories["ALL"]++;
				objInstalledMods.push(objCurrentMod);
			} catch (err) {
				var strName = strModID;
				if (objCurrentMod["display_name"] != null) {
					strName = objCurrentMod["display_name"];
				}
				alert("Error loading installed mod '" + strName + "'");
			}
		}
		
		function jsClearInstalledModData() {
			objInstalledMods = [];
		}
		
		function jsRemoveInstalledMod(strModID) {
			jsSetModEnabledStatus(strModID, false);
			for (var i = 0; i < objInstalledMods.length; i++) {
				if (objInstalledMods[i].id == strModID) {
					objInstalledMods.splice(i,1);
				}
			}
		}
		
		function jsModEnabledToggle(strModID) {
			var $checkbox = $('#mod' + strModID);
			var $image = $checkbox.next('#modimg' + strModID);
			
			$checkbox.prop("checked", !($checkbox.prop("checked")));
			
			if($checkbox.prop("checked") == true) {
				$image.attr('src', "manager/img/checkbox_checked.png");
			} else {
				$image.attr('src', "manager/img/checkbox_unchecked.png");
			}
			
			jsSetModEnabledStatus(strModID, document.getElementById("mod" + strModID).checked);			
			jsUpdateFiles();
		}
		
		function jsSetModEnabledStatus(strModID, boolEnabled) {
			var objThisMod = jsGetInstalledMod(strModID);
			objThisMod.enabled = boolEnabled;
			jsAddLogMessage("Mod '" + objThisMod.display_name + "' " + (boolEnabled ? "ENABLED" : "DISABLED"), 3);
						
			if (boolEnabled == true) {
				var boolReadyToEnable = true;
				if (objThisMod["requires"] != null) {
					for (var i = 0; i < objThisMod["requires"].length; i++) {
						if (jsGetInstalledMod(objThisMod["requires"][i]) == null) {
							
							var strName = objThisMod["requires"][i];
							if (jsGetOnlineMod(objThisMod["requires"][i]) != null) {
								strName = jsGetOnlineMod(objThisMod["requires"][i]).display_name;
							}
							alert("Cannot enable Mod: Required dependency '" + strName + "' is missing");
							boolReadyToEnable = false;
						} else {
							jsSetModEnabledStatus(objThisMod["requires"][i], boolEnabled);
						}
					}
				}
				if (document.getElementById("mod" + strModID)) {
					document.getElementById("mod" + strModID).checked = boolReadyToEnable;
					
					if (boolReadyToEnable) {
						document.getElementById("modimg" + strModID).src = "manager/img/checkbox_checked.png";
					} else {
						document.getElementById("modimg" + strModID).src = "manager/img/checkbox_unchecked.png";
					}
				}
			} else {
				for(var i = 0; i < objInstalledMods.length; i++) {
					if (objInstalledMods[i]["requires"] != null) {
						for (var j = 0; j < objInstalledMods[i]["requires"].length; j++) {
							if (objInstalledMods[i]["requires"][j] == strModID) {
								jsSetModEnabledStatus(objInstalledMods[i].id, false);
							}
						}
					}
				}
				if (document.getElementById("mod" + strModID)) {
					document.getElementById("mod" + strModID).checked = false;
					document.getElementById("modimg" + strModID).src = "manager/img/checkbox_unchecked.png";
				}
			}
			WriteModinfoJSON(strModID);
		}



		/* HTML Generation Functions */				
		function jsGenerateModEntryHTML(objMod, boolIsInstalled) {
			var strHTML_classes = "mod_entry";
			var id = objMod.id;
						
			/* Icon */
			var strHTML_icon_source = MOD_GENERIC_ICON_URL;
			if (objMod.icon != null) {
				strHTML_icon_source = objMod.icon;
			}
			var strHTML_icon = "<div class='mod_entry_icon'><img width='100%' height='100%' src='" + strHTML_icon_source + "'></div>";
					
			/* Name */
			var strHTML_display_name = "<div class='mod_entry_name'>" + objMod.display_name + "</div>";
			if (objMod["display_name_" + objOptions["locale"]] != null ) {
				strHTML_display_name = "<div class='mod_entry_name'>" + objMod["display_name_" + objOptions["locale"]] + "</div>";
			}
			
			/* Author */
			var strHTML_author = "<div class='mod_entry_author'>" + jsGetLocaleText('by', objOptions["locale"]) + " " + objMod.author + "</div>";
			
			/* Version */
			var strHTML_version = jsGetLocaleText('Version', objOptions["locale"]) + ": " + objMod.version;
			
			/* Build */
			var strHTML_build = "";
			if (objMod.build != null) {
				strHTML_build = ", " + jsGetLocaleText('build', objOptions["locale"]) + " " + objMod.build;
			}
			
			/* Date */
			var strHTML_date = "";
			if (objMod.date != null) {
				strHTML_date = " (" + objMod.date + ")";
			}
			
			/* Requires */
			var strHTML_requires = "";
			if (objMod.requires != null) {
				for (var j = 0; j < objMod.requires.length; j++) {
					if (jsGetInstalledMod(objMod.requires[j]) == null) {
						strHTML_requires += "<span class='mod_requirement_missing'>" + objMod.requires[j] + "</span>";
					} else {
						strHTML_requires += "<span class='mod_requirement'>" + objMod.requires[j] + "</span>";
					}
					
					if (j < objMod.requires.length - 1) {
						strHTML_requires += ", ";
					}
				}
				strHTML_requires = "<div class='mod_entry_requires'>" + jsGetLocaleText('REQUIRES', objOptions["locale"]) + ": " + strHTML_requires + "</div>";
			}

			
			/* Description */
			var strHTML_description = "<div class='mod_entry_description'>" + objMod.description + "</div>";
			if (objMod["description_" + objOptions["locale"]] != null) {
				strHTML_description = "<div class='mod_entry_description'>" + objMod["description_" + objOptions["locale"]] + "</div>";
			}
			
			/* Category */
			var strHTML_category = "";
			if (objMod.category != null) {
				for (var j = 0; j < objMod.category.length; j++) {
					strHTML_category += "<span class='mod_entry_category'>" + objMod.category[j] +"</span>";
					
					//TODO: additional safety
					var strSafeCategoryName = objMod.category[j].replace(" ", "-").toUpperCase(); 
					
					/* Update Classes */
					strHTML_classes = strHTML_classes.replace('mod_entry', 'mod_entry mod_entry_category_' + strSafeCategoryName);
					
					if (j < objMod.category.length - 1) {
						strHTML_category += ", ";
					}
				}
				strHTML_category = "<div class='mod_entry_categories'>" + strHTML_category + "</div>";
			}
			
			/* Forum Link */
			var strHTML_forum_link = "";
			if (objMod.forum != null) {
				strHTML_forum_link = "<div class='mod_entry_link' onclick='window.event.cancelBubble = true'>[ <a href='#' onClick='LaunchURL(\"" + objMod.forum + "\")'>" + jsGetLocaleText('forum', objOptions["locale"]) + "</a> ]</div>";
			}
			
			/* Installed Mods List Only */
			var strHTML_checkbox = "";
			var strHTML_checkbox_image = "";
			var strHTML_entry_onclick = "";
			var strHTML_uninstall_link = "";
			var strHTML_update_available = "";
			var strHTML_update_link = "";
			if (boolIsInstalled == true) {
				var objOnlineMod = jsGetOnlineMod(id);
			
				/* Update Classes */
				if (objOptions["installed_view"] == 'detailed') {
					strHTML_classes = strHTML_classes.replace('mod_entry', 'mod_entry mod_entry_detailed');
				} else {
					strHTML_classes = strHTML_classes.replace('mod_entry', 'mod_entry mod_entry_summary');
				}
				
				if (objOptions["installed_icon"] == false) {
					strHTML_icon = strHTML_icon.replace('mod_entry_icon', 'mod_entry_icon mod_entry_icon_disabled');
				}
				
				/* Enabled Checkbox, Image */
				if (objMod.enabled == true) {
					strHTML_checkbox = "<input type='checkbox' class='mod_entry_enabled' id='mod" + id + "' checked='checked'>";
					strHTML_checkbox_image = "<div class='mod_entry_enabled_image'><img id='modimg" + id + "' src='manager/img/checkbox_checked.png' /></div>";
				} else {
					strHTML_checkbox = "<input type='checkbox' class='mod_entry_enabled' id='mod" + id + "'>";
					strHTML_checkbox_image = "<div class='mod_entry_enabled_image'><img id='modimg" + id + "' src='manager/img/checkbox_unchecked.png' /></div>";
				}
				
				/* Mod OnClick Function */
				strHTML_entry_onclick = "onClick='jsModEnabledToggle(\"" + id + "\");'"
				
				/* Update Available Notification */
				if (objOnlineMod != null) {
					if (objMod.date < objOnlineMod.date) {
						strHTML_update_link = "<div class='mod_entry_link mod_entry_update_link'>[ <a href='#' onClick='jsPreInstallMod(\"" + objOnlineMod.url + "\",\"" + id + "\", {})'>" + jsGetLocaleText('update', objOptions["locale"]) + "</a> ]</div>";
						
						/* Update Classes */
						strHTML_classes = strHTML_classes.replace('mod_entry', 'mod_entry mod_entry_filter_update_available');
					}
				}
				
				/* Uninstall Link */
				strHTML_uninstall_link = "<div class='mod_entry_link mod_entry_uninstall_link' onclick='window.event.cancelBubble = true'>[ <a href='#' onClick='jsPreUninstallMod(\"" + id + "\")'>" + jsGetLocaleText('uninstall', objOptions["locale"]) + "</a> ]</div>";
			}
			
			/* Available Mods List Only */
			var strHTML_new = "";
			var strHTML_downloads = "";
			var strHTML_likes = "";
			var strHTML_install_link = "";
			if (boolIsInstalled == false) {
				var objInstalledMod = jsGetInstalledMod(id);
				var dateNow = new Date();
				var dateUpdate = new Date(objMod.date);
				
				/* Update Classes */
				if (objOptions["available_view"] == 'detailed') {
					strHTML_classes = strHTML_classes.replace('mod_entry', 'mod_entry mod_entry_detailed');
				} else {
					strHTML_classes = strHTML_classes.replace('mod_entry', 'mod_entry mod_entry_summary');
				}
			
				if (objOptions["available_icon"] == false) {
					strHTML_icon = strHTML_icon.replace('mod_entry_icon', 'mod_entry_icon mod_entry_icon_disabled');
				}
				
				/* Mod Newly Updated */
				if ((dateNow - dateUpdate)/(1000*60*60*24) < MOD_IS_NEW_PERIOD_DAYS) {
					strHTML_new = "<span class='mod_entry_new'> ! " + jsGetLocaleText('NEW', objOptions["locale"]) + "</span>";
					strHTML_classes = strHTML_classes.replace('mod_entry', 'mod_entry mod_entry_filter_new');
				}
				
				/* Install Link */
				
				if (objInstalledMod != null) {
					if (objMod.date > objInstalledMod.date) {
						strHTML_install_link = "<div class='mod_entry_link mod_entry_update_link'>[ <a href='#' onClick='jsPreInstallMod(\"" + objMod.url + "\", \"" + id + "\", {})'>" + jsGetLocaleText('update', objOptions["locale"]) + "</a> ]</div>";
						
						/* Update Classes */
						strHTML_classes = strHTML_classes.replace('mod_entry', 'mod_entry mod_entry_filter_update_available');
					} else {
						strHTML_install_link = "<div class='mod_entry_link mod_entry_reinstall_link'>[ <a href='#' onClick='jsPreInstallMod(\"" + objMod.url + "\", \"" + id + "\", {})'>" + jsGetLocaleText('reinstall', objOptions["locale"]) + "</a> ]</div>";
						
						/* Update Classes */
						strHTML_classes = strHTML_classes.replace('mod_entry', 'mod_entry mod_entry_filter_installed');
					}
				} else {
					strHTML_install_link = "<div class='mod_entry_link mod_entry_install_link'>[ <a href='#' onClick='jsPreInstallMod(\"" + objMod.url + "\", \"" + id + "\", {})'>" + jsGetLocaleText('install', objOptions["locale"]) + "</a> ]</div>";
					
					/* Update Classes */
					strHTML_classes = strHTML_classes.replace('mod_entry', 'mod_entry mod_entry_filter_not_installed');
				}
				
				/* Install Count */
				strHTML_downloads = "<img src='manager/img/download.png' style='position: absolute; margin-top:4px'> <div class='mod_entry_count'>" + objMod.downloads + "</div>"; //TODO: Fix Up
				
				/* Like Count */			
				if (objOptions["loadlikes"] == true) {
					if (objMod.likes != null) {
						if (objMod.likes == -2) {
							strHTML_likes = "<span id='" + id + "_like_count' class='mod_entry_likes'>" + jsGetLocaleText('Loading', objOptions["locale"]) + "...</span>" //TODO: Fix Up
						}
						if (objMod.likes >= 0) {
							strHTML_likes = "<img src='manager/img/like.png' height='15' width='15' style='position: absolute; margin-top:4px; margin-left: 8px;'> <div class='mod_entry_likes'>" + objMod.likes + "</div>"; //TODO: Fix Up
						}
					}
				}
			}
						
			var strHTML = "<div class='" + strHTML_classes + "' " + strHTML_entry_onclick + ">" + strHTML_icon + "<div class='mod_entry_container'>" + strHTML_checkbox + strHTML_checkbox_image + strHTML_display_name + strHTML_author + "<div class='mod_entry_details'>" + strHTML_version + strHTML_build + strHTML_date + strHTML_update_available + strHTML_new + "</div>" + strHTML_requires + strHTML_description + strHTML_category + strHTML_forum_link + strHTML_update_link + strHTML_install_link + strHTML_uninstall_link + strHTML_downloads + strHTML_likes + "</div></div>";
			
			return strHTML;
		}
		
		function jsGenerateOnlineModsListHTML() {
			jsAddLogMessage("Generating Available Mods List", 3);
			
			var strCategoryHTML = "";
			
			for (var category in objOnlineModCategories) {
				if(objOnlineModCategories.hasOwnProperty(category)){
					strCategoryHTML += "<div class='filter_area_category'><a href='#' id='filter_area_available_category_" + category + "' onClick='jsSetAvailableModsFilterCategory(\"" + category + "\")'>" + category + "</a> (" + objOnlineModCategories[category] + ")</div>";
				}
			}
		
			$("#mod_list_available").html("<div class='filter_area'>" +
				"<div class='filter_area_additional_options_toggle'>" +
					"<a href='#' id='filter_area_available_toggle' onClick='jsToggleModListOptions(false)'>" + jsGetLocaleText('Hide_Additional_Options', objOptions["locale"]) + "</a>" + 
				"</div>" + 
				"<table>" +
					"<tr>" +
						"<td class='filter_area_filter_heading'>" + jsGetLocaleText('Name_Filter', objOptions["locale"]) + ":</td>" +
						"<td class='filter_area_filter_list filter_area_text_filter'>" +
							"<input id='filter_area_available_text_filter' type='text' class='filter_area_textbox'>" + 
						"</td>" +
					"</tr>" + 
				"</table>" +
				"<table class='filter_area_container'>" +
					"<tr>" +
						"<td class='filter_area_filter_heading'>" + jsGetLocaleText('Show_Only', objOptions["locale"]) + ":</td>" +
						"<td class='filter_area_filter_list filter_area_filter_list_show'>" +
							"<a href='#' id='filter_area_show_all' onClick='jsSetAvailableModsFilter(\"ALL\")'>" + jsGetLocaleText('ALL', objOptions["locale"]) + "</a> - " +
							"<a href='#' id='filter_area_show_installed' onClick='jsSetAvailableModsFilter(\"INSTALLED\")'>" + jsGetLocaleText('INSTALLED', objOptions["locale"]) + "</a> - " + 
							"<a href='#' id='filter_area_show_not_installed' onClick='jsSetAvailableModsFilter(\"NOT_INSTALLED\")'>" + jsGetLocaleText('NOT_INSTALLED', objOptions["locale"]) + "</a> - " + 
							"<a href='#' id='filter_area_show_requires_update' onClick='jsSetAvailableModsFilter(\"REQUIRES_UPDATE\")'>" + jsGetLocaleText('NEEDS_UPDATE', objOptions["locale"]) + "</a> - " + 
							"<a href='#' id='filter_area_show_newly_updated' onClick='jsSetAvailableModsFilter(\"NEWLY_UPDATED\")'>" + jsGetLocaleText('NEWLY_UPDATED', objOptions["locale"]) + "</a>" + 
						"</td>" + 
					"</tr>" +
					"<tr>" + 
						"<td class='filter_area_filter_heading'>" + jsGetLocaleText('Sort_By', objOptions["locale"]) + ":</td>" +
						"<td class='filter_area_filter_list filter_area_filter_list_sort'>" + 
							"<a href='#' id='filter_area_sort_last_updated' onClick='jsSetAvailableModsSort(\"LAST_UPDATED\")'>" + jsGetLocaleText('LAST_UPDATED', objOptions["locale"]) + "</a> - " + 
							"<a href='#' id='filter_area_sort_last_title' onClick='jsSetAvailableModsSort(\"TITLE\")'>" + jsGetLocaleText('TITLE', objOptions["locale"]) + "</a> - " + 
							"<a href='#' id='filter_area_sort_last_author' onClick='jsSetAvailableModsSort(\"AUTHOR\")'>" + jsGetLocaleText('AUTHOR', objOptions["locale"]) + "</a> - " + 
							"<a href='#' id='filter_area_sort_last_build' onClick='jsSetAvailableModsSort(\"BUILD\")'>" + jsGetLocaleText('BUILD', objOptions["locale"]) + "</a> - " + 
							"<a href='#' id='filter_area_sort_last_downloads' onClick='jsSetAvailableModsSort(\"DOWNLOADS\")'>" + jsGetLocaleText('DOWNLOADS', objOptions["locale"]) + "</a> - " + 
							"<a href='#' id='filter_area_sort_last_likes' onClick='jsSetAvailableModsSort(\"LIKES\")'>" + jsGetLocaleText('LIKES', objOptions["locale"]) + "</a> - " + 
							"<a href='#' id='filter_area_sort_last_random' onClick='jsSetAvailableModsSort(\"RANDOM\")'>" + jsGetLocaleText('RANDOM', objOptions["locale"]) + "</a>" + 
						"</td>" +
					"</tr>" +
					"<tr>" + 
						"<td class='filter_area_filter_heading'>" + jsGetLocaleText('Category', objOptions["locale"]) + ":</td>" +
						"<td class='filter_area_filter_list filter_area_filter_list_category'>" + strCategoryHTML + "</td>" +
					"</tr>" +
				"</table>" +
				"<div id='filters_on_available'>" + 
					"<img class='filter_area_img' src='manager/img/filter.png'>" +
					"<div class='filter_area_message'> " + jsGetLocaleText('One_or_more_filters_are_currently_applied', objOptions["locale"]) + " " +
						"<span class='filter_area_link'>[ <a href='#' onClick='document.getElementById(\"filter_area_available_text_filter\").value=\"\"; jsSetAvailableModsFilter(\"ALL\"); jsSetAvailableModsFilterCategory(\"ALL\")'>" + jsGetLocaleText('clear', objOptions["locale"]) + "</a> ]</span>" +
					"</div>" +
				"</div>" +
			"</div>");
						
			$('#filter_area_available_text_filter').on("keyup", jsApplyOnlineModFilter);
			
			jsSortOnlineMods();
			
			var strHTML = "";
			
			for(var i = 0; i < objOnlineMods.length; i++) {
				strHTML += jsGenerateModEntryHTML(objOnlineMods[i], false);
			}
			
			$("#mod_list_available").append(strHTML);
			
			jsUpdateOptionsToggle(false);
			jsApplyOnlineModFilter();
		}
		
		function jsGenerateInstalledModsListHTML() {
			jsAddLogMessage("Generating Installed Mods List", 3);
						
			var strCategoryHTML = "";
			for (var category in objInstalledModCategories) {
				if(objInstalledModCategories.hasOwnProperty(category)){
					strCategoryHTML += "<div class='filter_area_category'><a href='#' id='filter_area_installed_category_" + category + "' onClick='jsSetInstalledModsFilterCategory(\"" + category + "\")'>" + category + "</a> (" + objInstalledModCategories[category] + ")</div>";
				}
			}
			
			$("#mod_list_installed").html("<div class='filter_area'>" +
				"<div class='filter_area_additional_options_toggle'>" +
					"<a href='#' id='filter_area_installed_toggle' onClick='jsToggleModListOptions(true)'>" + jsGetLocaleText('Hide_Additional_Options', objOptions["locale"]) + "</a>" + 
				"</div>" + 
				"<table>" +
					"<tr>" +
						"<td class='filter_area_filter_heading'>" + jsGetLocaleText('Name_Filter', objOptions["locale"]) + ":</td>" +
						"<td class='filter_area_filter_list filter_area_text_filter'>" + 
							"<input id='filter_area_installed_text_filter' type='text' class='filter_area_textbox'>" + 
						"</td>" +
					"</tr>" + 
				"</table>" +
				"<table class='filter_area_container'>" +
					"<tr>" + 
						"<td class='filter_area_filter_heading'>" + jsGetLocaleText('Category', objOptions["locale"]) + ":</td>" +
						"<td class='filter_area_filter_list filter_area_filter_list_category'>" + strCategoryHTML + "</td>" +
					"</tr>" +
					"<tr>" + 
						"<td class='filter_area_filter_heading'>" + jsGetLocaleText('Options', objOptions["locale"]) + ":</td>" +
						"<td>" + 
							"<div class='filter_area_option_img'><img src='manager/img/checkbox_checked.png' /></div>" +
							"<div class='filter_area_option_text'>&nbsp;<a href='#' onClick='jsSetAllModStatus(true)'>" + jsGetLocaleText('Enable_All', objOptions["locale"]) + "</a></div>" +
							"<div class='filter_area_option_img'><img src='manager/img/checkbox_unchecked.png' /></div>" +
							"<div class='filter_area_option_text'>&nbsp;<a href='#' onClick='jsSetAllModStatus(false)'>" + jsGetLocaleText('Disable_All', objOptions["locale"]) + "</a></div>" +
						"</td>" +
					"</tr>" +
				"</table>" +
				"<div id='filters_on_installed'>" +
					"<img class='filter_area_img' src='manager/img/filter.png'>" +
					"<div class='filter_area_message'> " + jsGetLocaleText('One_or_more_filters_are_currently_applied', objOptions["locale"]) + " " +
						"<span class='filter_area_link'>[ <a href='#' onClick='document.getElementById(\"filter_area_installed_text_filter\").value=\"\"; jsSetInstalledModsFilterCategory(\"ALL\")'>" + jsGetLocaleText('clear', objOptions["locale"]) + "</a> ]</span>" +
					"</div>" +
				"</div>" +
			"</div>");
			
			$('#filter_area_installed_text_filter').on("keyup", jsApplyInstalledModFilter);
			
			var strHTML = "";
			
			for(var i = 0; i < objInstalledMods.length; i++) {
				if (objInstalledMods[i].id != PAMM_MOD_ID) {
					strHTML += jsGenerateModEntryHTML(objInstalledMods[i], true);
				}
			}
			
			if (jsGetModsRequiringUpdates() > 0) {
				$("#mod_list_installed").append("<div class='alert_area'>" + 
					"<img class='alert_img' src='manager/img/alert.png'>" + 
					"<div class='alert_message'>" + jsGetModsRequiringUpdates() + " " + jsGetLocaleText('mod_s__require_updates', objOptions["locale"]) + " " + 
						"<span class='alert_link'>[ <a href='#' onClick='jsUpdateAll()'><span class='LOC_update_all'>" + jsGetLocaleText('update_all', objOptions["locale"]) + "</span></a> ]</span>" + 
					"</div>" + 
				"</div>");
				
				$("#ui_tab_installed_needing_update").html("&nbsp;(<span class='ui_tab_installed_needing_update_count'>" + jsGetModsRequiringUpdates() + "</span>)");
			} else {
				$("#ui_tab_installed_needing_update").html("");
			}
			
			$("#mod_list_installed").append(strHTML);
						
			jsUpdateOptionsToggle(true);
			jsApplyInstalledModFilter();
		}
				
		/* Mod Getter Functions */
		function jsGetOnlineMod(strModID) {
			for (var i = 0; i < objOnlineMods.length; i++) {
				if (objOnlineMods[i].id == strModID) {
					return objOnlineMods[i];
				}
			}
			return null;
		}
		
		function jsGetInstalledMod(strModID) {
			for (var i = 0; i < objInstalledMods.length; i++) {
				if (objInstalledMods[i].id == strModID) {
					return objInstalledMods[i];
				}
			}
			return null;
		}
		
		/* HTML Function Calls */
		function jsSetAllModStatus(boolStatus) {
			for (var i = 0; i < objInstalledMods.length; i++) {
				if (objInstalledMods[i].id != PAMM_MOD_ID) {
					if (objInstalledMods[i].enabled != boolStatus) {
						jsModEnabledToggle(objInstalledMods[i].id);
					}
				}
			}
		}
		
		function jsToggleModListOptions(boolInstalled) {
			var strListName = 'available';
			if (boolInstalled == true) {
				strListName = 'installed';
			}
			
			objOptions["show_" + strListName + "_filters"] = !objOptions["show_" + strListName + "_filters"];
			WriteOptionsJSON();
			jsUpdateOptionsToggle(boolInstalled)
		}
				
		function jsUpdateOptionsToggle(boolInstalled) {
			var strListName = 'available';
			if (boolInstalled == true) {
				strListName = 'installed';
			}
			
			if (objOptions["show_" + strListName + "_filters"] == true) {
				$("#filter_area_" + strListName + "_toggle").text(jsGetLocaleText('Hide_Additional_Options', objOptions["locale"]));
				$("#mod_list_" + strListName).find(".filter_area_container").show();
			} else {
				$("#filter_area_" + strListName + "_toggle").text(jsGetLocaleText('Show_Additional_Options', objOptions["locale"]));
				$("#mod_list_" + strListName).find(".filter_area_container").hide();
			}
		}
		
		function jsSetLanguage(boolSupressWrite) {
			objOptions["locale"] = document.getElementById("setting_language").value;
			jsAddLogMessage("Setting locale to " + objOptions["locale"], 3);
			$("#mod_list_available").html("");
			$("#mod_list_installed").html("");
			jsApplyLocaleText();
			jsGenerateInstalledModsListHTML();
			jsGenerateOnlineModsListHTML();
			if (boolSupressWrite !== true) {
				WriteOptionsJSON();
			}
		}
		
		function jsSetAvailableModsSort(strNewSort) {
			objOptions["sort"] = strNewSort;
			jsAddLogMessage("Available Mods sort by " + objOptions["sort"] + " applied", 4);
			WriteOptionsJSON();
			jsGenerateOnlineModsListHTML();
		}
		
		function jsSetAvailableModsFilter(strNewFilter) {
			objOptions["available_filter"] = strNewFilter;
			jsAddLogMessage("Available Mods filter " + objOptions["available_filter"] + " applied", 4);
			WriteOptionsJSON();
			jsApplyOnlineModFilter();
		}
		
		function jsSetInstalledModsFilterCategory(strNewCategory) {
			objOptions["installed_category"] = strNewCategory;
			jsAddLogMessage("Installed Mods category filter " + objOptions["installed_category"] + " applied", 4);
			WriteOptionsJSON();
			jsApplyInstalledModFilter();
		}
		
		function jsSetAvailableModsFilterCategory(strNewCategory) {
			objOptions["available_category"] = strNewCategory;
			jsAddLogMessage("Available Mod category filter " + objOptions["available_category"] + " applied", 4);
			WriteOptionsJSON();
			jsApplyOnlineModFilter();
		}
		
		function jsApplyOnlineModFilter() {
			var boolFiltersEnabled = true;
		
			$('#mod_list_available').find('.mod_entry').removeClass('mod_entry_filtered');
			$('#mod_list_available .filter_area_filter_list_show a').removeClass('filter_area_filter_item_selected');
			switch (objOptions["available_filter"]) {
				case "ALL":
					$('#filter_area_show_all').addClass('filter_area_filter_item_selected');
					boolFiltersEnabled = false;
					break;
				case "INSTALLED":
					$('#mod_list_available').find('.mod_entry').not('.mod_entry_filter_installed').addClass('mod_entry_filtered');
					$('#filter_area_show_installed').addClass('filter_area_filter_item_selected');
					break;
				case "REQUIRES_UPDATE":
					$('#mod_list_available').find('.mod_entry').not('.mod_entry_filter_update_available').addClass('mod_entry_filtered');
					$('#filter_area_show_requires_update').addClass('filter_area_filter_item_selected');
					break;
				case "NEWLY_UPDATED":
					$('#mod_list_available').find('.mod_entry').not('.mod_entry_filter_new').addClass('mod_entry_filtered');
					$('#filter_area_show_newly_updated').addClass('filter_area_filter_item_selected');
					break;
				case "NOT_INSTALLED":
					$('#mod_list_available').find('.mod_entry').not('.mod_entry_filter_not_installed').addClass('mod_entry_filtered');
					$('#filter_area_show_not_installed').addClass('filter_area_filter_item_selected');
					break;
			}
			
			if (objOptions["available_category"] != "ALL") {
				$('#mod_list_available').find('.mod_entry').not('.mod_entry_category_' + objOptions["available_category"]).addClass('mod_entry_filtered');
				boolFiltersEnabled = true;
			}
			$('#mod_list_available .filter_area_filter_list_category a').removeClass('filter_area_filter_item_selected');
			$('#filter_area_available_category_' + objOptions["available_category"]).addClass('filter_area_filter_item_selected');
			
			if ($('#filter_area_available_text_filter').val() != '') {
				var strSearch = $('#filter_area_available_text_filter').val().toLowerCase();
				$('#mod_list_available').find('.mod_entry').each(function() {
					if ($(this).find('.mod_entry_name').text().toLowerCase().indexOf(strSearch) < 0) {
						$(this).addClass('mod_entry_filtered');
					}
				});
				boolFiltersEnabled = true;
			}
			
			if (boolFiltersEnabled == true) {
				$('#filters_on_available').show();
			} else {
				$('#filters_on_available').hide();
			}
		}
		
		function jsApplyInstalledModFilter() {
			var boolFiltersEnabled = false;
			
			$('#mod_list_installed').find('.mod_entry').removeClass('mod_entry_filtered');
					
			if (objOptions["installed_category"] != "ALL") {
				$('#mod_list_installed').find('.mod_entry').not('.mod_entry_category_' + objOptions["installed_category"]).addClass('mod_entry_filtered');
				boolFiltersEnabled = true;
			}
			$('#mod_list_installed .filter_area_filter_list_category a').removeClass('filter_area_filter_item_selected');
			$('#filter_area_installed_category_' + objOptions["installed_category"]).addClass('filter_area_filter_item_selected');
			
			if ($('#filter_area_installed_text_filter').val() != '') {
				var strSearch = $('#filter_area_installed_text_filter').val().toLowerCase();
				$('#mod_list_installed').find('.mod_entry').each(function() {
					if ($(this).find('.mod_entry_name').text().toLowerCase().indexOf(strSearch) < 0) {
						$(this).addClass('mod_entry_filtered');
					}
				});
				boolFiltersEnabled = true;
			}
			
			if (boolFiltersEnabled == true) {
				$('#filters_on_installed').show();
			} else {
				$('#filters_on_installed').hide();
			}
		}
		
		function jsDisplayPanel(strPanelName) {			
			$('#news').hide();
			$('#newsButton').removeClass('ui_tab_link_selected');
			$('#installed').hide();
			$('#modListButton').removeClass('ui_tab_link_selected');
			$('#download').hide();
			$('#modDownloadButton').removeClass('ui_tab_link_selected');
			
			if (strPanelName == 'news') {
				$('#news').show();
				$('#newsButton').addClass('ui_tab_link_selected');
			}
			
			if (strPanelName == 'installed') {
				$('#installed').show();
				$('#modListButton').addClass('ui_tab_link_selected');
			}
			
			if (strPanelName == 'download') {
				$('#download').show();
				$('#modDownloadButton').addClass('ui_tab_link_selected');
			}
			
			document.getElementById('log').style.visibility = strPanelName == 'log' ? 'visible' : 'hidden';
			document.getElementById('log_icon').src = strPanelName == 'log' ? 'manager\\img\\log_select.png' : 'manager\\img\\log.png';
			document.getElementById('settings').style.visibility = strPanelName == 'settings' ? 'visible' : 'hidden';
			document.getElementById('settings_icon').src = strPanelName == 'settings' ? 'manager\\img\\settings_select.png' : 'manager\\img\\settings.png';
			document.getElementById('about').style.visibility = strPanelName == 'about' ? 'visible' : 'hidden';
			document.getElementById('about_icon').src = strPanelName == 'about' ? 'manager\\img\\about_select.png' : 'manager\\img\\about.png';
			strCurrentPanel = strPanelName;
		}
			
		function jsPreInstallMod(strURL, strModID, objModsPreInstalled) {
			
			var objThisMod = jsGetOnlineMod(strModID);
			
			if (objThisMod["requires"] != null) {
				for (var i = 0; i < objThisMod["requires"].length; i++) {
					if (jsGetInstalledMod(objThisMod["requires"][i]) == null && objModsPreInstalled[objThisMod["requires"][i]] == null) {
						objModsPreInstalled[objThisMod["requires"][i]] = true;
						var strName = objThisMod["requires"][i];
						if (jsGetOnlineMod(objThisMod["requires"][i]) != null) {
							strName = jsGetOnlineMod(objThisMod["requires"][i]).display_name;
							var boolConfirm = confirm("Install required dependency '" + strName + "'?");
							if (boolConfirm == true) {
								objModsPreInstalled = jsPreInstallMod(jsGetOnlineMod(objThisMod["requires"][i]).url, objThisMod["requires"][i], objModsPreInstalled);
							}
						} else {
							alert("Warning: Required dependency '" + strName + "' unavailable");
						}
					}
				}
			}
			
			jsDelayedInstall(strURL, strModID);
			return objModsPreInstalled;
		}
		
		function jsDelayedInstall(strURL, strModID) {
			if (strModInstalling != "") {
				setTimeout(function() { 
					jsDelayedInstall(strURL, strModID);
				}, 500);
			} else {
				strModInstalling = strModID;
				InstallMod(strURL + "?r=" + Math.random(), strModID);
			}
		}
		
		function jsPreUninstallMod(strModID) {
			var boolConfirm = confirm("Are you sure you want to uninstall '" + jsGetInstalledMod(strModID).display_name + "'?");
			
			if (boolConfirm == true) {
				UninstallMod(strModID);
				jsRefresh(false, false);
			}
		}
		
		function jsSetModsListView(boolInstalled, boolSupressWrite) {
			var strListName = 'available';
			if (boolInstalled == true) {
				strListName = 'installed';
			}
			
			objOptions[strListName + "_view"] = document.getElementById("setting_" + strListName + "_view").value;
			if (boolSupressWrite !== true) {
				WriteOptionsJSON();
			}
			
			if (objOptions[strListName + "_view"] == 'detailed') {
				$("#mod_list_" + strListName).find(".mod_entry").addClass("mod_entry_detailed");
				$("#mod_list_" + strListName).find(".mod_entry").removeClass("mod_entry_summary");
			} else {
				$("#mod_list_" + strListName).find(".mod_entry").removeClass("mod_entry_detailed");
				$("#mod_list_" + strListName).find(".mod_entry").addClass("mod_entry_summary");
			}
		}
				
		function jsSetModsListIcon(boolInstalled, boolSupressWrite) {
			var strListName = 'available';
			if (boolInstalled == true) {
				strListName = 'installed';
			}
			
			objOptions[strListName + "_icon"] = document.getElementById("setting_" + strListName + "_icon").checked;
			if (boolSupressWrite !== true) {
				WriteOptionsJSON();
			}
			
			if (objOptions[strListName + "_icon"] == true) {
				$("#mod_list_" + strListName).find(".mod_entry_icon").removeClass("mod_entry_icon_disabled");
			} else {
				$("#mod_list_" + strListName).find(".mod_entry_icon").addClass("mod_entry_icon_disabled");
			}
		}
				
		/* Download Functions */
		function jsCheckOnlineStatus(successFunction) {
			var HTTP_OK = 200;
			jsAddLogMessage("Checking online status", 3);
			
			boolOnline = false;
			
			try {
				var oXMLHTTP = new ActiveXObject("MSXML2.XMLHTTP");
			} catch(e) {
				jsAddLogMessage("Critical Error: Could not create MSXML2.XMLHTTP ActiveX object: " + e.message, 1);
			}
			
			var strURL = PAMM_ONLINE_TEST_URL + "?r=" + Math.random();
			oXMLHTTP.open("GET", strURL, true);
			
			var intCurrentMessageID = intMessageID;
			oXMLHTTP.onreadystatechange = function() { 
				
				if (oXMLHTTP.readyState == 4) {
					document.getElementById("downloading").style.display = "none";
					jsAddLogMessage("[Message ID: " + intCurrentMessageID + "] HTTP " + oXMLHTTP.statusText + " (" + oXMLHTTP.status + ") <span class='log_url' title='" + strURL + "'>&lt;url&gt;</span>", 4);
					if (oXMLHTTP.status == HTTP_OK) {
						boolOnline = true;
					}
					document.getElementById("downloading").style.display = "none";
					jsAddLogMessage("Online status: " + (boolOnline == true ? "ONLINE" : "OFFLINE"), 2);
					eval(successFunction);
				}
			};
			
			try {
				document.getElementById("downloading").style.display = "block";
				jsAddLogMessage("[Message ID: " + intMessageID + "] GET <span class='log_url' title='" + PAMM_ONLINE_TEST_URL + "'>&lt;url&gt;</span>", 4);
				oXMLHTTP.send();
			} catch(e) {
				jsAddLogMessage("Network Error: attempting to send request to " + PAMM_ONLINE_TEST_URL + "?r=" + Math.random() + ": " + e.message, 1);
			}
			intMessageID++;
		}
		
		function jsDownload(strURL, strOutput, strOutputFilePath, successFunction) {
			try {
				var oXMLHTTP = new ActiveXObject("MSXML2.XMLHTTP");
			} catch(e) {
				jsAddLogMessage("Critical Error: Could not create MSXML2.XMLHTTP ActiveX object: " + e.message, 1);
			}
		
			oXMLHTTP.open("GET", strURL, true);
			
			var intCurrentMessageID = intMessageID;
			oXMLHTTP.onreadystatechange = function() { jsDownloadStateChange(oXMLHTTP, strURL, intCurrentMessageID, strOutput, strOutputFilePath, successFunction);};
			intMessageID++;
			
			try {
				document.getElementById("downloading").style.display = "block";
				jsAddLogMessage("[Message ID: " + intCurrentMessageID + "] GET <span class='log_url' title='" + strURL + "'>&lt;url&gt;</span>", 4);
				intDownloading++;
				oXMLHTTP.send();
			} catch(e) {
				jsAddLogMessage("Network Error: attempting to send request to " + strURL + ": " + e.message, 1);
			}

		}
		
		function jsDownloadStateChange(oXMLHTTP, strURL, intID, strOutput, strOutputFilePath, successFunction) {
			var HTTP_OK = 200;
			var HTTP_NOT_FOUND = 404;
			var adTypeBinary = 1;
			var adTypeText = 2;
			var adSaveCreateOverWrite = 2;
			var xmlReadyStates = ['Request not initialized', 'Server connection established', 'Request received ', 'Processing request', 'Request finished and response is ready'];
			
			//jsAddLogMessage("[Message ID: " + intID + "] " + xmlReadyStates[oXMLHTTP.readyState], 4);
			if (oXMLHTTP.readyState == 4) {
			
				try {
					var oStream = new ActiveXObject("ADODB.Stream");
				} catch(e) {
					jsAddLogMessage("Critical Error: Could not create ADODB.Stream ActiveX object", 1);
				}
			
				intDownloading--;
				if (intDownloading == 0) {
					document.getElementById("downloading").style.display = "none";
				}
				jsAddLogMessage("[Message ID: " + intID + "] HTTP " + oXMLHTTP.statusText + " (" + oXMLHTTP.status + ") <span class='log_url' title='" + strURL + "'>&lt;url&gt;</span>", 4);
				if (oXMLHTTP.status == HTTP_OK) {
					if (strOutput == "string") {
						oStream.Type = adTypeBinary;
						oStream.Open ();
						oStream.Write (oXMLHTTP.responseBody);
						oStream.Position = 0;
						oStream.Type = adTypeText;
						oStream.CharSet = "utf-8"; //"shift_jis";
						var strText = oStream.ReadText (oStream.Size)
						oStream.Close();
						if (successFunction != null) {
							eval(successFunction);
						}
					}
					if (strOutput == "file") {
						
						oStream.Open();
						oStream.Type = adTypeBinary;
						oStream.Write(oXMLHTTP.ResponseBody);

						try {
							oStream.SaveToFile(strOutputFilePath, adSaveCreateOverWrite);
						} catch(e) {
							jsAddLogMessage("Write Error: Could not save file '" + strOutputFilePath + "': " + e.message, 1);
						}
						
						oStream.Close();
						if (successFunction != null) {
							eval(successFunction);
						}
					}
					if (strOutput == null) {
						if (successFunction != null) {
							eval(successFunction);
						}
					}
				} else {
					var strText = null;
					eval(successFunction);
				}
				oStream = null;
			}
			oXMLHTTP = null;
		}
		
		/* Refresh & Update Functions */
		function jsUpdateFiles() {
			if (boolAutoWrite == true) {
				WriteModsJSON();
				WriteUIModListJS();
				WriterModListJS();
			}
		}
		
		function jsRefresh(boolShowLoading, boolDownloadData) {
			//TODO: Localisation
			if (boolShowLoading == true) {
				document.getElementById("news_data").innerHTML = "<div class=\"loading\">" + jsGetLocaleText('Loading', objOptions["locale"]) + "...</div>";
				document.getElementById("mod_list_installed").innerHTML = "<div class=\"loading\">" + jsGetLocaleText('Loading', objOptions["locale"]) + "...</div>";
				document.getElementById("mod_list_available").innerHTML = "<div class=\"loading\">" + jsGetLocaleText('Loading', objOptions["locale"]) + "...</div>";
				document.getElementById('total_available_mods').innerHTML = jsGetLocaleText('Loading', objOptions["locale"]) + "...";
				document.getElementById('total_available_mod_downloads').innerHTML = jsGetLocaleText('Loading', objOptions["locale"]) + "...";
			}
			
			if (boolDownloadData == true) {
				jsCheckOnlineStatus("jsRefresh_asynch(" + boolDownloadData + ")");
			} else {
				jsRefresh_asynch(boolDownloadData)
			}
		}
		
		function jsRefresh_asynch(boolDownloadData) {
			if (boolOnline == false) {
				document.getElementById("news_data").innerHTML = "<div class=\"loading\">" + jsGetLocaleText('Mod_Manager_is_offline', objOptions["locale"]) + "</div>";	
				document.getElementById("mod_list_available").innerHTML = "<div class=\"loading\">" + jsGetLocaleText('Mod_Manager_is_offline', objOptions["locale"]) + "</div>";
				document.getElementById('total_available_mods').innerHTML = jsGetLocaleText('Mod_Manager_is_offline', objOptions["locale"]);
				document.getElementById('total_available_mod_downloads').innerHTML = jsGetLocaleText('Mod_Manager_is_offline', objOptions["locale"]);
				document.getElementById('current_pa_build').innerHTML = jsGetLocaleText('Mod_Manager_is_offline', objOptions["locale"]) + " (" + jsGetLocaleText('Last_known_build', objOptions["locale"]) + ": " + strPABuild + ")";
			}
			
			if (boolOnline == true) {
				jsDownloadPAMMversion();
			}
				
			jsAddLogMessage("Refreshing Data", 2);
			

			objInstalledModCategories["ALL"] = 0;
			FindInstalledMods();
			document.getElementById('total_installed_mods').innerHTML = objInstalledMods.length;
			objInstalledMods.sort(sort_by('display_name', true, null));

			if (boolOnline == true && boolDownloadData == true) {
				jsDownloadNews();
				jsDownloadOnlineMods();
			} else {
				jsGenerateInstalledModsListHTML();
				if (boolOnline == true) {
					jsGenerateOnlineModsListHTML();
				}
			}
		}
		
		function jsGetModsRequiringUpdates() {
			var intModsRequiringUpdate = 0;
		
			for(var i = 0; i < objInstalledMods.length; i++) {
				if (jsGetOnlineMod(objInstalledMods[i]["id"]) != null && objInstalledMods[i]["date"] < jsGetOnlineMod(objInstalledMods[i]["id"])["date"]) {
					intModsRequiringUpdate++;
				}
			}
			return intModsRequiringUpdate;
		}
		
		/* Settings Functions */
		function jsToggleModLikes(boolSupressWrite) {
			objOptions["modlikes"] = document.getElementById("setting_likes").checked;
			if (boolSupressWrite !== true) {
				WriteOptionsJSON();
			}
		}
		
		function jsToggleDebugMode(boolSupressWrite) {
			jsSetLogLevel(document.getElementById("setting_debug").checked ? 4 : objOptions["verbose"] ? 3 : 2);
			objOptions["debug"] = document.getElementById("setting_debug").checked;
			if (boolSupressWrite !== true) {
				WriteOptionsJSON();
			}
		}
		
		function jsToggleVerboseMode(boolSupressWrite) {
			jsSetLogLevel(document.getElementById("setting_debug").checked ? 4 : document.getElementById("setting_verbose").checked ? 3 : 2);
			objOptions["verbose"] = document.getElementById("setting_verbose").checked;
			if (boolSupressWrite !== true) {
				WriteOptionsJSON();
			}
		}
		
		function jsSetDefaultTab(boolSupressWrite) {
			objOptions["tab"] = document.getElementById("setting_defaultTab").value;
			jsAddLogMessage("Setting default tab to " + objOptions["tab"], 3);
			if (boolSupressWrite !== true) {
				WriteOptionsJSON();
			}
		}
		
		/* Log Functions */
		function jsAddLogMessage(strText, intLevel) {
			var strType = "INFO";
			if (intLevel == 1) { 
				strType = "ERROR"; 
			}
			if (intLevel == 4) { 
				strType = "DEBUG"; 
			}
			
			var objCurrentTime = new Date();
			var strHours = objCurrentTime.getHours() < 10 ? "0" + objCurrentTime.getHours() : objCurrentTime.getHours();
			var strMinutes = objCurrentTime.getMinutes() < 10 ? "0" + objCurrentTime.getMinutes() : objCurrentTime.getMinutes();
			var strSeconds = objCurrentTime.getSeconds() < 10 ? "0" + objCurrentTime.getSeconds() : objCurrentTime.getSeconds();

			document.getElementById("log_data").innerHTML += '<div id="log_' + intLogNumber + '" class="log_entry' + (intLevel == 4 ? "_debug" : "") + ' log_level' + intLevel + '"><div class="log_time">' + strHours + ':' + strMinutes + ':' + strSeconds + '</div><div class="log_type">[' + strType + ']</div> ' + strText + '</div>';
			
			if (intLevel <= intLogLevel) { 
				$("#log_" + intLogNumber).css({display: "block"});
			}

			document.getElementById("log_data").scrollTop = document.getElementById("log_data").scrollHeight;
			intLogNumber++;
		}
		
		function jsSetLogLevel(intLevel) {
			var strLevel = "INFO";
			if (intLevel == 1) { 
				strLevel = "ERROR"; 
			}
			if (intLevel == 3) { 
				strLevel = "INFO - VERBOSE"; 
			}
			if (intLevel == 4) { 
				strLevel = "DEBUG"; 
			}
			if (intLevel != intLogLevel) {
				jsAddLogMessage("Setting log level to " + intLevel + " (" + strLevel + ")", 3);
				intLogLevel = intLevel;
				$(".log_level3").css({display: intLogLevel >= 3 ? "block" : "none"});
				$(".log_level4").css({display: intLogLevel >= 4 ? "block" : "none"});
			}
		}
		
		/* Downloads & Asynch Callbacks */
		function jsDownloadNewPAMMinstaller(strPath) {
			if (boolOnline == true) {
				jsAddLogMessage("Downloading new PAMM installer", 2);
				jsDownload(objPAMMVersionData.url, "file", strPath, "InstallPAMM('" + objPAMMVersionData.filename + "')");
			}
		}
				
		function jsDownloadOnlineMods(strURL) {
			if (boolOnline == true) {
				jsAddLogMessage("Downloading available mods list", 2);
				jsDownload(ONLINE_MODS_LIST_URL + "?r=" + Math.random(), "string", null, "jsDownloadOnlineMods_asynch(strText)");
			}
		}
				
		function jsDownloadOnlineMods_asynch(strResult) {
			try {
				objOnlineMods = [];
				objOnlineModCategories = {};
				
				objOnlineModCategories["ALL"] = 0;
			
				var objModData = JSON.parse(strResult);
				for (var id in objModData) {
					objModData[id]["id"] = id;
					objModData[id]["likes"] = -2;
					objOnlineMods.push(objModData[id]);
					if (jsGetInstalledMod(id) != null && jsGetInstalledMod(id)["date"] < objModData[id]["date"]) {
						jsAddLogMessage("Update available for installed mod '" + jsGetInstalledMod(id)["display_name"] + "': " + objModData[id]["version"] + " (" + objModData[id]["date"] + ")", 3);
					}
					
					if (objModData[id].category != null) {
						for (var i = 0; i < objModData[id].category.length; i++) {
							var strCurrentCategory = objModData[id].category[i].replace(" ", "-").toUpperCase();
							if (objOnlineModCategories[strCurrentCategory] == null) {
								objOnlineModCategories[strCurrentCategory] = 1;
							} else {
								objOnlineModCategories[strCurrentCategory]++;
							}
						}
					}
					objOnlineModCategories["ALL"]++;
				}
				document.getElementById('total_available_mods').innerHTML = objOnlineMods.length;
				jsDownloadOnlineModDownloadCount();
			} catch (e) {
				jsAddLogMessage("Error loading online mod data: " + e.message, 1);
			}
		}
		
		function jsDownloadOnlineModDownloadCount() {
			if (boolOnline == true) {
				jsAddLogMessage("Getting availailable mod download counts", 2);
				jsDownload(ONLINE_MODS_DOWNLOAD_COUNT_URL + "?r=" + Math.random(), "string", null, "jsDownloadOnlineModDownloadCount_asynch(strText)");
			}
		}
		
		function jsDownloadOnlineModDownloadCount_asynch(strResult) {
			var intTotalDownloadCount = 0;
			
			try {
				var objOnlineModsDownloadCount = JSON.parse(strResult);
				for (var i = 0; i < objOnlineMods.length; i++) {
					objOnlineMods[i]["downloads"] = objOnlineModsDownloadCount[objOnlineMods[i].id] ? objOnlineModsDownloadCount[objOnlineMods[i].id] : 0;
					intTotalDownloadCount += objOnlineMods[i]["downloads"];
				}
				
				jsGenerateOnlineModsListHTML();
				jsGenerateInstalledModsListHTML();
				if (objOptions["modlikes"] == true) {
					jsDownloadOnlineModLikeCount();
				}
				WriterModListJS();
			} catch (e) {
				jsAddLogMessage("Error loading online mod download count data: " + e.message, 1);
			}
			document.getElementById('total_available_mod_downloads').innerHTML = intTotalDownloadCount;
		}
		
		function jsDownloadOnlineModLikeCount() {
			jsAddLogMessage("Getting mod likes", 2);
			for (var i = 0; i < objOnlineMods.length; i++) {
				
			
				if (objOnlineMods[i]["forum"] != null) {
					if (objOnlineMods[i]["forum"].indexOf("forums.uberent.com") > -1) {
						intLikeCountRemaining++;
						jsDownload(objOnlineMods[i]["forum"], "string", null, "jsDownloadOnlineModLikeCount_asynch('" + objOnlineMods[i].id + "' , strText)");
					} else {
						jsAddLogMessage("Invalid forum link for mod '" + objOnlineMods[i]["display_name"] + "' (Not from forums.uberent.com)", 3);
						objOnlineMods[i]["likes"] = -1;
					}
				} else {
					jsAddLogMessage("Missing forum link for mod '" + objOnlineMods[i]["display_name"] + "'", 3);
					objOnlineMods[i]["likes"] = -1;
				}
			}
			
			var objTimer = setInterval(function() {
				if(intLikeCountRemaining == 0) {
					jsGenerateOnlineModsListHTML();
					clearInterval(objTimer);
				}
			}, 100);
		}
		
		function jsDownloadOnlineModLikeCount_asynch(intModID, strResult) {
			var objOnlineMod = jsGetOnlineMod(intModID);
			try {
				var objNodes = $(strResult).find(".message").first().find(".LikeText");
				var intLikes = objNodes.children(".username").length;
				if  (objNodes.children(".OverlayTrigger").length > 0) {
					var strText = objNodes.children(".OverlayTrigger").text();
					intLikes += parseInt(strText);
				}
				objOnlineMod["likes"] = intLikes;
				jsAddLogMessage("Like count for mod '" + objOnlineMod["display_name"] + "': " + intLikes, 3);
			} catch (e) {
				jsAddLogMessage("Error loading online mod like count data: " + e.message, 1);
				objOnlineMod["likes"] = -1;
			}
			intLikeCountRemaining--;
		}
		
		function jsDownloadPAMMversion() {
			if (boolOnline == true) {
				jsAddLogMessage("Checking for PAMM updates", 2);
				jsDownload(PAMM_VERSION_DATA_URL + "?r=" + Math.random(), "string", null, "jsDownloadPAMMversion_asynch(strText)");
			}
		}
		
		function jsDownloadPAMMversion_asynch(strResult) {
			try {
				objPAMMVersionData = JSON.parse(strResult);
				var dateLatestPAMM = new Date(objPAMMVersionData.date);
				strPABuild = objPAMMVersionData.build;
				
				document.getElementById('current_pa_build').innerHTML = strPABuild;
				
				jsAddLogMessage("Latest version of PAMM: " + objPAMMVersionData.version + " (" + objPAMMVersionData.date + ")", 2);
				if (new Date(datePAMM) < dateLatestPAMM) {
					jsAddLogMessage("New version of PAMM available: " + objPAMMVersionData.version + " (" + objPAMMVersionData.date + ")", 2);
					UpdatePAMM(objPAMMVersionData.version, objPAMMVersionData.filename);
				} else {
					jsAddLogMessage("Latest version of PAMM installed", 2);
				}
			} catch (e) {
				jsAddLogMessage("Error loading PAMM version data: " + e.message, 1);
				document.getElementById('current_pa_build').innerHTML = strPABuild;
			}
		}
		
		function jsDownloadNews() {
			if (boolOnline == true) {
				jsAddLogMessage("Downloading news", 2);
				jsDownload(NEWS_URL + "?r=" + Math.random(), "string", null, "jsDownloadNews_asynch(strText)");
			}
		}
		
		function jsDownloadNews_asynch(strResult) {
			document.getElementById("news_data").innerHTML = strResult;
		}
	</script>
		
	<!-- GUI related functions -->
	<script language="VBScript">
		Dim objShell
		Dim objFSO
		Dim objApp
	
		Call Initialise()
			
		'Initialisation of variables
		Sub Initialise()
			Set objApp = CreateObject("Shell.Application")
			Set objFSO = CreateObject("Scripting.FileSystemObject")
			Set objShell = CreateObject("WScript.Shell")
			
			objShell.currentDirectory = Left(window.location.pathname, InStrRev(window.location.pathname, "\") - 1)
			
			strModsDirectoryPath = objShell.expandenvironmentstrings("%LOCALAPPDATA%") & "\Uber Entertainment\Planetary Annihilation\mods"
			strPAMMCacheDirectoryPath = objShell.expandenvironmentstrings("%LOCALAPPDATA%") & "\Uber Entertainment\Planetary Annihilation\pamm_cache"
			
			Call CreateFolderIfNotExists(objShell.expandenvironmentstrings("%LOCALAPPDATA%") & "\Uber Entertainment\")
			Call CreateFolderIfNotExists(objShell.expandenvironmentstrings("%LOCALAPPDATA%") & "\Uber Entertainment\Planetary Annihilation\")
			Call CreateFolderIfNotExists(objShell.expandenvironmentstrings("%LOCALAPPDATA%") & "\Uber Entertainment\Planetary Annihilation\mods\")
			Call CreateFolderIfNotExists(objShell.expandenvironmentstrings("%LOCALAPPDATA%") & "\Uber Entertainment\Planetary Annihilation\mods\rPAMM\")
			Call CreateFolderIfNotExists(objShell.expandenvironmentstrings("%LOCALAPPDATA%") & "\Uber Entertainment\Planetary Annihilation\mods\rPAMM\ui\")
			Call CreateFolderIfNotExists(objShell.expandenvironmentstrings("%LOCALAPPDATA%") & "\Uber Entertainment\Planetary Annihilation\mods\rPAMM\ui\mods\")
			Call CreateFolderIfNotExists(objShell.expandenvironmentstrings("%LOCALAPPDATA%") & "\Uber Entertainment\Planetary Annihilation\pamm_cache\")
			
			Set objPAMMFile = objFSO.GetFile("manager\modinfo.json")
			Call objPAMMFile.Copy(strModsDirectoryPath & "\rPAMM\modinfo.json", true)
		End Sub
		
		Sub CreateFolderIfNotExists(strPath)
			If Not(objFSO.FolderExists(strPath)) Then
				objFSO.CreateFolder(strPath)
			End If
		End Sub
		
		'Launches a URL in the user's browser of choice
		Sub LaunchURL(strURL)
			Call jsAddLogMessage("Launching URL: " & strURL, 3)
			objShell.Run(strURL)
		End Sub
		
		'Closes the PA Mod Manager
		Sub ClosePAMM()
			Call Self.Close()
		End Sub
				
		'Searches the PA Installation for modlist.json files
		Sub FindInstalledMods()
			Dim objFolder
			Dim objFile
			Dim objFiles
			Dim intMods
			Dim objStream

			Set objStream = CreateObject("ADODB.Stream")
			objStream.CharSet = "utf-8"			
			
			
			
			Set objFolder = objFSO.GetFolder(strModsDirectoryPath)

			Call jsClearInstalledModData()
			
			intMods = 0
			For Each objSubFolder in objFolder.SubFolders
				Set objFiles = objSubFolder.Files
				For Each objFile in objFiles
					If objFile.Name = "modinfo.json" Then
						Call objStream.open()
						
						Call jsAddLogMessage("Found installed mod: " & objSubFolder.name, 3)
						Call objStream.LoadFromFile(objSubFolder.path & "\" & objFile.name)
						
						Call jsLoadInstalledModData(objSubFolder.name, objStream.ReadText())
						
						Call objStream.close()
						intMods = intMods + 1
					End If
				Next
			Next
			Call jsAddLogMessage("Found " & intMods & " installed mods", 2)
			
			
			Call jsUpdateFiles()
		End Sub
		
		'Loads in options data
		Sub LoadOptions()
			Dim objStream

			Set objStream = CreateObject("ADODB.Stream")
			objStream.CharSet = "utf-8"	
			
			If objFSO.FileExists(strPAMMCacheDirectoryPath & "\" & PAMM_OPTIONS_FILENAME) = True Then
				Call objStream.open()
				Call jsAddLogMessage("Options file found, loading settings", 3)
				
				Call objStream.LoadFromFile(strPAMMCacheDirectoryPath & "\" & PAMM_OPTIONS_FILENAME)
				Call jsLoadOptionsData(objStream.ReadText())
				
				Call objStream.close()
			Else
				Call jsAddLogMessage("Options file not found, using defaults", 3)
				Call jsLoadOptionsData("{}")
			End If
		End Sub
		
		'Writes Options file
		Sub WriteOptionsJSON()
			Dim objStream
			Const adModeReadWrite = 3
			Const adTypeText = 2
			Const adLF = 10
		
			Set objStream = CreateObject("ADODB.Stream")
			objStream.CharSet = "utf-8"	
			objStream.Type = adTypeText
			objStream.Mode = adModeReadWrite
			objStream.LineSeparator = adLF
			
			Call objStream.open()
				
			Call objStream.WriteText(jsGetOptionsDataString())
			Call WriteUTF8WithoutBOM(objStream, strPAMMCacheDirectoryPath & "\" & PAMM_OPTIONS_FILENAME)
			
			Call jsAddLogMessage("Writing options file", 4)
			
			Call objStream.flush()
			Call objStream.close()
		End Sub
		
		'Writes data to ui_mod_list.js
		Sub WriteUIModListJS()
			Dim objStream
			Const adModeReadWrite = 3
			Const adTypeText = 2
			Const adLF = 10
		
			Set objStream = CreateObject("ADODB.Stream")
			objStream.CharSet = "utf-8"	
			objStream.Type = adTypeText
			objStream.Mode = adModeReadWrite
			objStream.LineSeparator = adLF
			
			Call objStream.open()
			
			Call objStream.WriteText("var global_mod_list = " & jsGetUIModListGlobalDataString() & ";" & NEW_LINE & NEW_LINE)
			Call objStream.WriteText("var scene_mod_list = " & jsGetUIModListSceneDataString())
			Call WriteUTF8WithoutBOM(objStream, strModsDirectoryPath & "\rPAMM\ui\mods\ui_mod_list.js")
			
			Call jsAddLogMessage("Writing ui_mod_list.js", 4)
			
			Call objStream.flush()
			Call objStream.close()
		End Sub
		
		'Writes data to mods_list.json
		Sub WriterModListJS()
			Dim objStream
			Const adModeReadWrite = 3
			Const adTypeText = 2
			Const adLF = 10
		
			Set objStream = CreateObject("ADODB.Stream")
			objStream.CharSet = "utf-8"	
			objStream.Type = adTypeText
			objStream.Mode = adModeReadWrite
			objStream.LineSeparator = adLF
			
			Call objStream.open()
			
			Call jsAddLogMessage("Writing mods_list.json", 4)
			Call objStream.WriteText(jsGetInstalledModListDataString())
			
			Call WriteUTF8WithoutBOM(objStream, strModsDirectoryPath & "\rPAMM\ui\mods\mods_list.json")
			
			Call objStream.flush()
			Call objStream.close()
		End Sub
		
		'Writes data to mods.json
		Sub WriteModsJSON()
			Dim objStream
			Const adModeReadWrite = 3
			Const adTypeText = 2
			Const adLF = 10
		
			Set objStream = CreateObject("ADODB.Stream")
			objStream.CharSet = "utf-8"	
			objStream.Type = adTypeText
			objStream.Mode = adModeReadWrite
			objStream.LineSeparator = adLF
			
			Call objStream.open()
			
			Call jsAddLogMessage("Writing mods.json", 4)
			Call objStream.WriteText(jsGetModsJSONDataString())
			
			Call WriteUTF8WithoutBOM(objStream, strModsDirectoryPath & "\mods.json")
			
			Call objStream.flush()
			Call objStream.close()
		End Sub
		
		'Writes the contents of a mods modinfo.json
		Sub WriteModinfoJSON(strModID)
			Dim objStream
			Const adModeReadWrite = 3
			Const adTypeText = 2
			Const adLF = 10
		
			Set objStream = CreateObject("ADODB.Stream")
			objStream.CharSet = "utf-8"	
			objStream.Type = adTypeText
			objStream.Mode = adModeReadWrite
			objStream.LineSeparator = adLF
		
			If objFSO.FileExists(strModsDirectoryPath & "\" & strModID & "\modinfo.json") Then
			
				Call objStream.open()
				
				Call jsAddLogMessage("Writing modsinfo.json for mod '" & strModID & "'", 4)
				Call objStream.WriteText(jsGetInstalledModDataString(strModID))
			
				Call WriteUTF8WithoutBOM(objStream, strModsDirectoryPath & "\" & strModID & "\modinfo.json")
				
				Call objStream.flush()
				Call objStream.close()
			End If
		End Sub
		
		Sub WriteUTF8WithoutBOM(objStream, strSavePath)
			Dim objBinaryStream
			Const adSaveCreateOverWrite = 2
			Const adModeReadWrite = 3
			Const adTypeBinary = 1
			
			Set objBinaryStream = CreateObject("ADODB.Stream")
			objBinaryStream.Type = adTypeBinary
			objBinaryStream.Mode = adModeReadWrite
			objBinaryStream.Open
			
			objStream.position = 3
			objStream.CopyTo objBinaryStream
	
			objBinaryStream.SaveToFile strSavePath, adSaveCreateOverWrite
			
			Call objBinaryStream.flush()
			Call objBinaryStream.close()
		End Sub
		
		'Downloads and installs a mod
		Sub InstallMod(strURL, strModID)
			Dim strModFileName
			
			'Extract File Name from URL
			strModFileName = Right(strURL, Len(strURL) - inStrRev(strURL, "/"))
			strModFileName = Left(strModFileName, inStr(strModFileName, "?")-1)
			
			Call Randomize()
			Call RemoveFileFromCache(strModFileName)
			
			Call jsDownload(MANAGE_URL & "?download=" & strModID & "&r=" & rnd(), null, null, null)
			
			Call jsAddLogMessage("Downloading mod '" & strModID & "'", 3)
			Call jsDownload(strURL, "file", strPAMMCacheDirectoryPath & "\" & strModFileName, "UninstallMod('" & strModID & "'); ExtractMod('" & strModFileName & "', '" & strModID & "')")
		End Sub
		
		'Extracts a Mod Zip file to the mods folder
		Sub ExtractMod(strFileName, strModID)
			Dim objFiles
			
			'Check for existence of mod zip file
			If objFSO.FileExists(strPAMMCacheDirectoryPath & "\" & strFileName) = True Then
			
				'Get all files in zip
				set objFiles = objApp.NameSpace(strPAMMCacheDirectoryPath & "\" & strFileName).items

				'Extract to mods directory
				Call jsAddLogMessage("Installing mod '" & strModID & "'", 3)
				objApp.NameSpace(strModsDirectoryPath).CopyHere(objFiles)
				Call jsRefresh(false, false)
				Call jsSetModEnabledStatus(strModID, true)
			End If
			
			If strModInstalling <> "" Then
				strModInstalling = ""
			End If
		End Sub
		
		'Removes a specified file from the cache, if it exists
		Sub RemoveFileFromCache(strFileName)
		
			'Check for and remove existing file if present
			If objFSO.FileExists(strPAMMCacheDirectoryPath & "\" & strFileName) = True Then
				On Error Resume Next
				Err.Clear
				
				Call jsAddLogMessage("Clearing cached file '" & strFileName & "'", 4)
				
				'Can throw errors
				objFSO.deleteFile strPAMMCacheDirectoryPath & "\" & strFileName, true
				
				'An error occurred
				If Err.Number <> 0 Then
					Call DisplayError("Cache Error: Unable to remove existing file '" & strFileName & "'." & vbnewline & Err.Description)
					Err.Clear
				End If
				
				On Error Goto 0
			End If
		End Sub
		
		'Uninstalls a mod
		Sub UninstallMod(strModID)
			If objFSO.FolderExists(strModsDirectoryPath & "\" & strModID) = True Then
				On Error Resume Next
				Err.Clear
				
				Call jsAddLogMessage("Uninstalling mod '" & strModID & "'", 2)
				
				'Can throw errors
				objFSO.deleteFolder strModsDirectoryPath & "\" & strModID, true
				
				'An error occurred
				If Err.Number <> 0 Then
					Call DisplayError("File Error: Unable to remove folder '" & strModID & "'." & vbnewline & Err.Description)
					Err.Clear
				End If
				
				On Error Goto 0
				
				Call jsRemoveInstalledMod(strModID)
			End If
		End Sub

		'Determines if a new version of PAMM is available, and offers to install it
		Sub UpdatePAMM(strVersion, strFilename)
			Const vbOKCancel = 1
			Const vbOK = 1
			Dim intResult
			
			intResult = msgbox("Version " & strVersion & " of PA Mod Manager is now available. Click OK to download and install.", vbOKCancel)
				
			if intResult = vbOK Then
				Call jsDownloadNewPAMMinstaller(strPAMMCacheDirectoryPath & "\" & strFilename)
			End If
		End Sub
			
		'Runs installer for new PAMM version
		Sub InstallPAMM(strFilename)
			objApp.ShellExecute strPAMMCacheDirectoryPath & "\" & strFilename, "", "", "runas", 1
			Call ClosePAMM()
		End Sub
		
		'Returns whether PA.exe exists at the specified location
		Function CheckPAPresent(strPath)
			CheckPAPresent = false
			On Error Resume Next
			Err.Clear
			
			CheckPAPresent = objFSO.FileExists(strPath)
						
			On Error Goto 0
		End Function
		
		'Launches PA
		Sub LaunchPA()
			objApp.ShellExecute jsGetOption("pa_path"), "", "", "", ""
			Call ClosePAMM()
		End Sub
		
		Sub OpenModsFolder()
			objApp.ShellExecute strModsDirectoryPath, "", "", "", ""
		End Sub

	</script>

	<body onLoad="jsOnLoad()">
		<div id="container">
			<div class="banner_heading"><span class="LOC_MOD_MANAGER">MOD MANAGER</span></div>
			<div class="banner_image"><img src="manager\img\img_pa_logo_start_rest.png"></div>
			<div class="ui_tabs">
				<div class="ui_tab_link"><span class="ui_tab_edges">[</span> <div class="ui_tab_label"><a href="#" id="newsButton" onclick="jsDisplayPanel('news')"><span class="LOC_NEWS">NEWS</span></a></div> <span class="ui_tab_edges">]</span></div>
				<div class="ui_tab_link"><span class="ui_tab_edges">[</span> <div class="ui_tab_label"><a href="#" id="modListButton" onclick="jsDisplayPanel('installed')"><span class="LOC_INSTALLED_MODS">INSTALLED MODS</span></a><span id="ui_tab_installed_needing_update"></span></div> <span class="ui_tab_edges">]</span></div>
				<div class="ui_tab_link"><span class="ui_tab_edges">[</span> <div class="ui_tab_label"><a href="#" id="modDownloadButton" onclick="jsDisplayPanel('download')"><span class="LOC_AVAILABLE_MODS">AVAILABLE MODS</span></a></div> <span class="ui_tab_edges">]</span></div>
				<div class="ui_tab_link ui_tab_link_image"><a href="#" id="logButton" onclick="jsDisplayPanel('log')"><img id="log_icon" src="manager\img\log.png"></a></div>
				<div class="ui_tab_link ui_tab_link_image"><a href="#" id="settingsButton" onclick="jsDisplayPanel('settings')"><img id="settings_icon" src="manager\img\settings.png"></a></div>
				<div class="ui_tab_link ui_tab_link_image"><a href="#" id="aboutButton" onclick="jsDisplayPanel('about')"><img id="about_icon" src="manager\img\about.png"></a></div>
			</div>
			
			<div id="installed" class="tab">
				<div id="mod_list_installed" class="tab_content">
				</div>
			</div>
			<div id="download" class="tab">
				<div class="mod_download_options">
					<div class="filter_options">
						<span class="LOC_SHOW">SHOW</span>: <a href="#" id="filter_text" onmousedown="jsToggleAvailableModsFilter()"><span class="LOC_ALL">ALL</span></a>
					</div>
					<div class="sort_options">
						<span class="LOC_SORT">SORT</span>: <span id="sort_text"><a href="#" onmousedown="jsToggleAvailableModsSort()"><span class="LOC_LAST_UPDATED">LAST UPDATED</span></a></span>
					</div>
					<div class="filter_options">
						<span class="LOC_FILTER">FILTER</span>: <input type="text" id="show_filter" />
					</div>
				</div>
				<div id="mod_list_available" class="tab_content">
				</div>
			</div>
			<div id="news" class="tab">
				<div id="news_data" class="tab_content">
					
				</div>
			</div>
			<div id="log" class="tab">
				<div id="log_data" class="tab_content">
					<div class="tab_heading"><span class="LOC_LOG">LOG</span></div>
				</div>
			</div>
			<div id="settings" class="tab">
				<div id="settings_data" class="tab_content">
					<div class="tab_heading"><span class="LOC_SETTINGS">SETTINGS</span></div>
					<div class="settings_items">
						<table class="settings_table">
							<tr>
								<td><span class="setting_heading"><span class="LOC_Language">Language</span>:</span></td>
								<td>
									<select id="setting_language" onChange="jsSetLanguage()">
										<option value="en">ENGLISH</option>
										<option value="fr">FRANAIS</option>
										<option value="nl">NEDERLANDS</option>
										<option value="de">DEUTSCH</option>
									</select>
								</td>
							</tr>
							<tr>
								<td><span class="setting_heading"><span class="LOC_Default_Tab">Default Tab</span>:</span></td>
								<td>
									<select id="setting_defaultTab" onChange="jsSetDefaultTab()">
										<option value="news" class="LOC_NEWS">NEWS</option>
										<option value="installed" class="LOC_INSTALLED_MODS">INSTALLED MODS</option>
										<option value="download" class="LOC_AVAILABLE_MODS">AVAILABLE MODS</option>
									</select>
								</td>
							</tr>
							
							<tr style="display:none">
								<td><span class="setting_heading"><span class="LOC_Verbose_Log">Verbose Log</span>:</span></td>
								<td><input id="setting_verbose" type="checkbox" onClick="jsToggleVerboseMode()"/></td>
							</tr>
							<tr>
								<td><span class="setting_heading"><span class="LOC_Debug_Mode">Debug Mode</span>:</span></td>
								<td><input id="setting_debug" type="checkbox" onClick="jsToggleDebugMode()"/></td>
							</tr>
							<tr>
								<td><span class="setting_heading"><span class="LOC_Mod_Likes">Load Mod Likes</span>:</span></td>
								<td><input id="setting_likes" type="checkbox" onClick="jsToggleModLikes()"/> (<span class="LOC_Requires_Refresh">Requires Refresh</span>)</td>
							</tr>
							<tr>
								<td><span class="setting_heading"><span class="LOC_Installed_Mods_List_View">Installed Mods List View</span>:</span></td>
								<td>
									<select id="setting_installed_view" onChange="jsSetModsListView(true)">
										<option value="summary" class="LOC_SUMMARY_VIEW">SUMMARY VIEW</option>
										<option value="detailed" class="LOC_DETAILED_VIEW">DETAILED VIEW</option>
									</select>
									<br/>
									<input id="setting_installed_icon" type="checkbox" onClick="jsSetModsListIcon(true)"/><span class="LOC_Show_Icon">Show Icon</span>
								</td>
							</tr>
							<tr>
								<td><span class="setting_heading"><span class="LOC_Available_Mods_List_View">Available Mods List View</span>:</span></td>
								<td>
									<select id="setting_available_view" onChange="jsSetModsListView(false)">
										<option value="summary" class="LOC_SUMMARY_VIEW">SUMMARY VIEW</option>
										<option value="detailed" class="LOC_DETAILED_VIEW">DETAILED VIEW</option>
									</select>
									<br/>
									<input id="setting_available_icon" type="checkbox" onClick="jsSetModsListIcon(false)"/><span class="LOC_Show_Icon">Show Icon</span>
								</td>
							</tr>
							<tr>
								<td colspan="2">
									<span class="setting_heading"><span class="LOC_PA_Install_Location">PA Install Location</span>:</span><br/>
									<input id="setting_installLocation" type="text" disabled="true" class="textInput"/>
								</td>
							</tr>
							<tr>
								<td colspan="2">
									<span class="setting_heading"><span class="LOC_PA_Mod_Location">PA Mods Location</span>:</span><br/>
									<input id="setting_modLocation" type="text" disabled="true" class="textInput"/>
									<input type="button" value="Open" class="LOC_Open openModsFolderButton" onClick="OpenModsFolder()"/>
								</td>
							</tr>
						</table>
					</div>
				</div>
			</div>
			<div id="about" class="tab">
				<div id="about_data" class="tab_content">
					<div class="tab_heading"><span class="LOC_ABOUT">ABOUT</span></div>
					<div class="about_items">
						<div class="tab_subheading"><span class="LOC_Planetary_Annihilation_Mod_Manager">Planetary Annihilation Mod Manager</span></div>
						<div class="tab_about_text"><span class="LOC_Version">Version</span> <span class="tab_about_value">4.0.4</span> (2014/04/30)</div>
						<div class="tab_about_text"><span class="LOC_Current_PA_Build">Current PA Build</span>: <span id="current_pa_build" class="tab_about_value"><span class="LOC_Loading">Loading</span>...</span></div>
						<div class='mod_entry_link'>[ <a href='#' onClick='LaunchURL("https://forums.uberent.com/threads/rel-pa-mod-manager-v3-2-0.50726/")'><span class='LOC_forum'>forum</span></a> ]</div>
						<br/><br/>
						<div class="tab_subheading"><span class="LOC_Statistics">Statistics</span></div>
						<div class="tab_about_text"><span class="LOC_Total_Available_Mods">Total Available Mods</span>: <span id="total_available_mods" class="tab_about_value">Loading...</span></div>
						<div class="tab_about_text"><span class="LOC_Total_Mod_Downloads">Total Mod Downloads</span>: <span id="total_available_mod_downloads" class="tab_about_value">Loading...</span></div>
						<div class="tab_about_text"><span class="LOC_Current_Mods_Installed">Current Mods Installed</span>: <span id="total_installed_mods" class="tab_about_value">Loading...</span></div>
						<br/>
						<div class="tab_subheading"><span class="LOC_Credits">Credits</span></div>
						<div class="tab_about_text"><span class="LOC_Created_by">Created by</span> <span class="tab_about_user"><a href='#' onClick='LaunchURL("https://forums.uberent.com/members/?username=Raevn")'>raevn</a></span></div>
						<div class="tab_about_text"><span class="LOC_Mac_Linux_port_created_by">Mac/Linux port created by</span> <span class="tab_about_user"><a href='#' onClick='LaunchURL("https://forums.uberent.com/members/?username=DeathByDenim")'>DeathByDenim</a></span></div>
						<div class="tab_about_text"><span class="LOC_Mod_list_generator_created_by">Mod list generator created by</span> <span class="tab_about_user"><a href='#' onClick='LaunchURL("https://forums.uberent.com/members/?username=elitedanzel")'>elitedanzel</a></span> <span class="LOC_and">and</span> <span class="tab_about_user"><a href='#' onClick='LaunchURL("https://forums.uberent.com/members/?username=proeleert")'>proeleert</a></span></div>
						<div class="tab_about_text"><span class="LOC_Thanks_also">Thanks also to those on the Uber Entertainment forums who tested and provided feedback on this program, especially</span> <span class="tab_about_user"><a href='#' onClick='LaunchURL("https://forums.uberent.com/members/?username=Cola_Colin")'>Cola_Colin</a></span>, <span class="tab_about_user"><a href='#' onClick='LaunchURL("https://forums.uberent.com/members/?username=dfanz0r")'>dfanz0r</a></span> <span class="LOC_and">and</span> <span class="tab_about_user"><a href='#' onClick='LaunchURL("https://forums.uberent.com/members/?username=LavaSnake")'>LavaSnake</a></span></div>
					</div>
				</div>
			</div>
			
			<div class="buttons">
				<input id="btnLaunch" type="button" value="Launch PA" class="LOC_Launch_PA" onClick="LaunchPA()"/>
				<input type="button" value="Refresh" class="LOC_Refresh" onClick="jsRefresh(true, true)"/>
				<input type="button" value="Exit" class="LOC_Exit" onClick="ClosePAMM()"/>
			</div>
			<div id="downloading">
				<img src="manager/img/loading.gif">
			</div>
		</div>
	</body>

	<script type="text/javascript">
		function jsParseCommandlineArg(commandlineArg)
		{
			jsAddLogMessage("Parsing commandline argument: " + commandlineArg, 4);
			var mod_id_str;
			//if we are dealing with a pamm url
			if (commandlineArg.lastIndexOf("pamm://", 0) === 0 ) {
				//extract mod id from pamm url
				mod_id_str = commandlineArg.substring(7);
				while (mod_id_str.lastIndexOf("/") != -1) {
					mod_id_str = mod_id_str.substring(0, mod_id_str.length - 1);
				}
				//find mod url from mod id
				var curr_mod = jsGetOnlineMod(mod_id_str);
				if (curr_mod != null) {
					jsPreInstallMod(curr_mod.url, mod_id_str, {});
					alert("Installing '" + curr_mod.display_name + "'");
				} else {
					jsAddLogMessage("Failed to install from commandline with mod id = " + mod_id_str, 1);
				}
			} else {
				jsAddLogMessage("Commandline argument unexpected format", 4);
			}
		}
	</script>
	
	<script language="VBScript">
		Sub LoadCommandlineArgs
			arrCommands = Split(PAMM.commandLine, chr(34))
			For i = 3 to (Ubound(arrCommands) - 1) Step 2
				Call jsParseCommandlineArg(arrCommands(i))
			Next
		End Sub
	</script>
	
	<script type="text/javascript">
		function jsOnLoad() {
			jsApplyLocaleText();
			document.getElementById("btnLaunch").disabled = true;
			LoadOptions();
			setTimeout(function() {
				jsRefresh(true, true);
			}, 500);
			commandlineSetIntervalID = setInterval(function() {
				//check objOnlineMods exists and is populated
				if (objOnlineMods != null && objOnlineMods != undefined && objOnlineMods.length > 0) {
					jsAddLogMessage("Parsing commandline arguments", 4);
					LoadCommandlineArgs();
					clearInterval(commandlineSetIntervalID);
				}
			}, 500);
		}
	</script>
</html>
