<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
	<head>
		<title>PA UI Mod Manager</title>
		<HTA:APPLICATION ID="PAMM" APPLICATIONNAME="PA UI Mod Manager" SCROLL="no" SINGLEINSTANCE="no" ICON="manager\img\favicon.ico">
		<link href="manager\pamm.css" rel="stylesheet" type="text/css">
	</head>

	<script type="text/javascript" src="manager\json3.min.js"></script>
	<script type="text/javascript" src="manager\jquery-1.10.2.min.js"></script>
	<script type="text/javascript" src="manager\locale.js"></script>
	
	<script type="text/javascript">	
		self.resizeTo(520, 600);
		
		var objInstalledMods = [];
		var objOnlineMods = [];
		var objPAMMVersionData = {};
		var objOptions = {};
		
		var strCurrentPanel = "news";
		var strOnlineModsFilter = "ALL";
		var strOnlineModsSort = "LAST_UPDATED";
		var boolAutoWrite = true;
		var boolOnline = true;
		var intDownloading = 0;
		var strModInstalling = "";
		var intLogLevel = 0;
		var intLogNumber = 0;
		var intLikeCountRemaining = 0;
		var intMessageID = 0;
		var strCurrentLocale = "en";
		
		var ONLINE_MODS_LIST_URL = "http://pamods.github.io/modlist.json";
		var ONLINE_MODS_DOWNLOAD_COUNT_URL = "http://pa.raevn.com/modcount_json.php";
		var MANAGE_URL = "http://pa.raevn.com/manage.php";
		var MOD_IS_NEW_PERIOD_DAYS = 7;
		var NEW_LINE = "\r\n";
		var NEWS_URL = "http://pamods.github.io/news.html";
		var PAMM_VERSION_DATA_URL = "http://pa.raevn.com/pammversion.json";
		var PAMM_MOD_ID = "rPAMM";
		var PAMM_OPTIONS_FILENAME = "pamm.json";
		var PAMM_ONLINE_TEST_URL = "http://pa.raevn.com/pamm_online.txt";
		
		var datePAMM = "2014/02/03";
		var strPAMMversion = "3.1.2";
		
		/* Localisation Functions */
		function jsGetLocaleText(strKey, strLocale) {
			if (strlocaleText[strKey] != null) {
				if (strlocaleText[strKey][strLocale] != null && strlocaleText[strKey][strLocale] != "") {
					return strlocaleText[strKey][strLocale];
				} else if (strlocaleText[strKey]["en"] != null) {
					return strlocaleText[strKey]["en"];
				}
			}
			return null;
		}
		
		function jsApplyLocaleText() {
			for (var i = 0; i < strLocaleTextItems.length; i++) {
				var objLocItems = $(".LOC_" + strLocaleTextItems[i]);
				if (objLocItems.length > 0) {
					if (objLocItems.prop("tagName") == "INPUT") {
						objLocItems.attr("value", jsGetLocaleText(strLocaleTextItems[i], strCurrentLocale));
					} else {
						objLocItems.text(jsGetLocaleText(strLocaleTextItems[i], strCurrentLocale));
					}
				}
			}
		}
		
		/* Sorting Functions */
		function sort_random(){
			return (Math.round(Math.random())-0.5);
		}
		
		function sort_by(field, reverse, primer) {
			var key = primer ? function(x) {return primer(x[field])} : function(x) {return x[field]};
			reverse = [-1, 1][+!!reverse];

			return function (a, b) {
				return a = key(a), b = key(b), reverse * ((a > b) - (b > a));
			} 
		}
		
		function jsSortOnlineMods() {
			switch (strOnlineModsSort) {
				case "LAST_UPDATED":
					objOnlineMods.sort(sort_by('date', false, function(x) { return new Date(x); } ));
					break;
				case "TITLE":
					objOnlineMods.sort(sort_by('display_name', true, null));
					break;
				case "AUTHOR":
					objOnlineMods.sort(sort_by('author', true, null));
					break;
				case "BUILD":
					objOnlineMods.sort(sort_by('build', true, null));
					break;
				case "LIKES":
					objOnlineMods.sort(sort_by('likes', false, parseInt));
					break;
				case "DOWNLOADS":
					objOnlineMods.sort(sort_by('downloads', false, parseInt));
					break;
				case "RANDOM":
					objOnlineMods.sort(sort_random);
					break;
			}
		}
		
		/* Data Strings */
		function jsGetInstalledModListDataString() {
			var strInstalledModsList = {};
			
			for (var i = 0; i < objInstalledMods.length; i++) {
				strInstalledModsList[objInstalledMods[i].id] = objInstalledMods[i]
			}
			return JSON.stringify(strInstalledModsList, null, 4).replace(/\r?\n/g, NEW_LINE);
		}
		
		function jsGetUIModListGlobalDataString() {
			var global_mod_list = [];
			objInstalledMods.sort(sort_by('priority', true, parseInt));
		
			for (var i = 0; i < objInstalledMods.length; i++) {
				if (objInstalledMods[i].enabled == true) {
					if (objInstalledMods[i]["global_mod_list"] != null) {
						for (var j = 0; j < objInstalledMods[i]["global_mod_list"].length; j++) {
							global_mod_list.push(objInstalledMods[i]["global_mod_list"][j]);
						}
					}
				}
			}
			return JSON.stringify(global_mod_list, null, 4).replace(/\r?\n/g, NEW_LINE);
		}
		
		function jsGetUIModListSceneDataString() {
			var scene_mod_list  = {"connect_to_game": [], "game_over": [], "icon_atlas": [], "live_game": [], "load_planet": [], "lobby": [], "matchmaking": [], "new_game": [], "server_browser": [], "settings": [], "special_icon_atlas": [], "start": [], "system_editor": [], "transit": [], "social": [], "replay_browser": []};
			objInstalledMods.sort(sort_by('priority', true, parseInt));
			
			for (var i = 0; i < objInstalledMods.length; i++) {
				if (objInstalledMods[i].enabled == true) {
					for(var scene in objInstalledMods[i]) {
						if (scene_mod_list[scene] != null) {
							for(var j = 0; j < objInstalledMods[i][scene].length; j++) {
								scene_mod_list[scene].push(objInstalledMods[i][scene][j]);
							}
						}
					}
				}
			}
			return JSON.stringify(scene_mod_list, null, 4).replace(/\r?\n/g, "\r\n");
		}
		
		function jsGetInstalledModDataString(strModID) {
			if (jsGetInstalledMod(strModID) != null) { 
				return JSON.stringify(jsGetInstalledMod(strModID), null, 4).replace(/\r?\n/g, NEW_LINE);
			} else {
				return "";
			}
		}
		
		function jsGetModsJSONDataString() {
			var strOutput = {};
			strOutput["mount_order"] = [];
			
			objInstalledMods.sort(sort_by('priority', true, parseInt));
			
			for (var i = 0; i < objInstalledMods.length; i++) {
				if (objInstalledMods[i].enabled == true) {
					strOutput["mount_order"].push(objInstalledMods[i].identifier);
				}
			}
			return JSON.stringify(strOutput, null, 4).replace('\r\n', '\n').replace(/\r?\n/g, NEW_LINE);
		}
		
		/* Option Functions */
		function jsLoadOptionsData(strOptionsDataString) {
			objOptions = {};
			try {
				objOptions = JSON.parse(strOptionsDataString);
			} catch (err) {
				alert("An error occurred loading options file");
			}
			if (objOptions["pa_path"] == null) {
				objOptions["pa_path"] = "c:\\Program Files (x86)\\Planetary Annihilation\\PA\\PA.exe"
				if (CheckPAPresent(objOptions["pa_path"]) == false) {
					objOptions["pa_path"] = "C:\\Program Files (x86)\\Steam\\SteamApps\\common\\Planetary Annihilation\\PA.exe"
				}
			}
			
			var strPrompt = CheckPAPresent(objOptions["pa_path"]);
			
			while (strPrompt != null && strPrompt != true) {
				strPrompt = prompt("Could not find Planetary Annihilation. Please enter path to PA.exe", objOptions["pa_path"]);
				objOptions["pa_path"] = strPrompt;
				if (strPrompt != null) {
					strPrompt = CheckPAPresent(strPrompt);
				}
			}
			
			document.getElementById("setting_installLocation").value = objOptions["pa_path"];
			
			if (objOptions["debug"] != null) {
				document.getElementById("setting_debug").checked = objOptions["debug"];
			} else {
				document.getElementById("setting_debug").checked = false;
			}
			jsToggleDebugMode();
			
			if (objOptions["verbose"] != null) {
				document.getElementById("setting_verbose").checked = objOptions["verbose"];
			} else {
				document.getElementById("setting_verbose").checked = false;
			}
			jsToggleVerboseMode();
			
			if (objOptions["filter"]  != null) {
				strOnlineModsFilter = objOptions["filter"];
				document.getElementById('filter_text').innerHTML = "<span class='LOC_" + strOnlineModsFilter + "'>" + jsGetLocaleText(strOnlineModsFilter, strCurrentLocale) + "</span>";
			}
			
			if (objOptions["sort"]  != null) {
				strOnlineModsSort = objOptions["sort"];
				document.getElementById('sort_text').innerHTML = '<a href="#" onmousedown="jsToggleAvailableModsSort()"><span class="LOC_' + strOnlineModsSort + '">' + jsGetLocaleText(strOnlineModsSort, strCurrentLocale) + '</span></a>';
				
				if (strOnlineModsSort == "RANDOM") {
					document.getElementById('sort_text').innerHTML += ' <a href="#" onmousedown="jsGenerateOnlineModsListHTML()"><img src="manager/img/refresh.png" border=0></a>';
				}
			}
			
			if (objOptions["tab"] != null) {
				jsDisplayPanel(objOptions["tab"]);
				document.getElementById('setting_defaultTab').value = objOptions["tab"];
			}
			
			if (objOptions["locale"] != null) {
				document.getElementById('setting_language').value = objOptions["locale"];
				jsSetLanguage();
			}
			
			document.getElementById("btnLaunch").disabled = strPrompt == null;
			WriteOptionsJSON();
		}
		
		function jsGetOptionsDataString() {
			return JSON.stringify(objOptions, null, 4).replace('\r\n', '\n').replace(/\r?\n/g, NEW_LINE)
		}
		
		function jsGetOption(strOption) {
			return objOptions[strOption];
		}
				
		/* Installed Mod Functions */
		function jsLoadInstalledModData(strModID, strModDataString) {
			var objCurrentMod = {};
			try {
				objCurrentMod = JSON.parse(strModDataString);
				
				objCurrentMod["priority"] = objCurrentMod["priority"] ? objCurrentMod["priority"] : 100;
				if (objCurrentMod["enabled"] == null || strModID == PAMM_MOD_ID) {
					objCurrentMod["enabled"] = true;
				}
				objCurrentMod["id"] = strModID;
				objInstalledMods.push(objCurrentMod);
			} catch (err) {
				var strName = strModID;
				if (objCurrentMod["display_name"] != null) {
					strName = objCurrentMod["display_name"];
				}
				alert("Error loading installed mod '" + strName + "'");
			}
		}
		
		function jsClearInstalledModData() {
			objInstalledMods = [];
		}
		
		function jsRemoveInstalledMod(strModID) {
			jsSetModEnabledStatus(strModID, false);
			for (var i = 0; i < objInstalledMods.length; i++) {
				if (objInstalledMods[i].id == strModID) {
					objInstalledMods.splice(i,1);
				}
			}
		}
		
		function jsToggleInstalledMod(strModID) {	
			var boolEnabled = document.getElementById("mod" + strModID).checked;
			document.getElementById("mod" + strModID).checked = !boolEnabled;
			jsModEnabledToggle(strModID);
		}
		
		function jsModEnabledToggle(strModID) {
			jsSetModEnabledStatus(strModID, document.getElementById("mod" + strModID).checked);			
			jsUpdateFiles();
		}
		
		function jsSetModEnabledStatus(strModID, boolEnabled) {
			var objThisMod = jsGetInstalledMod(strModID);
			objThisMod.enabled = boolEnabled;
			jsAddLogMessage("Mod '" + objThisMod.display_name + "' " + (boolEnabled ? "ENABLED" : "DISABLED"), 3);
						
			if (boolEnabled == true) {
				var boolReadyToEnable = true;
				if (objThisMod["requires"] != null) {
					for (var i = 0; i < objThisMod["requires"].length; i++) {
						if (jsGetInstalledMod(objThisMod["requires"][i]) == null) {
							
							var strName = objThisMod["requires"][i];
							if (jsGetOnlineMod(objThisMod["requires"][i]) != null) {
								strName = jsGetOnlineMod(objThisMod["requires"][i]).display_name;
							}
							alert("Cannot enable Mod: Required dependency '" + strName + "' is missing");
							boolReadyToEnable = false;
						} else {
							jsSetModEnabledStatus(objThisMod["requires"][i], boolEnabled);
						}
					}
				}
				if (document.getElementById("mod" + strModID)) {
					document.getElementById("mod" + strModID).checked = boolReadyToEnable;
				}
			} else {
				for(var i = 0; i < objInstalledMods.length; i++) {
					if (objInstalledMods[i]["requires"] != null) {
						for (var j = 0; j < objInstalledMods[i]["requires"].length; j++) {
							if (objInstalledMods[i]["requires"][j] == strModID) {
								jsSetModEnabledStatus(objInstalledMods[i].id, false);
							}
						}
					}
				}
				if (document.getElementById("mod" + strModID)) {
					document.getElementById("mod" + strModID).checked = false;
				}
			}
			WriteModinfoJSON(strModID);
		}
		
		/* HTML Generation Functions */
		function jsGenerateOnlineModsListHTML() {
			jsAddLogMessage("Generating Available Mods List", 3);
			jsSortOnlineMods();
			
			var strHTML = "";
			var intOnlineMods = objOnlineMods.length;
			
			for(var i = 0; i < intOnlineMods; i++) {
				var mod = objOnlineMods[i];
				var id = mod.id;
				
				var strFiltered = "";
				var strDate = mod.date ? " (" + mod.date + ")" : "";
				var strBuild = mod.build ? ", build " + mod.build : "";
				var strIcon = "<div class='mod_icon'><img width='100' height='100' src='" + (mod.icon ? mod.icon : "http://pa.raevn.com/icons/generic.png") + "'></div>";
				var strDisplayName = mod["display_name_" + strCurrentLocale] ? mod["display_name_" + strCurrentLocale] : mod.display_name;
				var strDescription = mod["description_" + strCurrentLocale] ? mod["description_" + strCurrentLocale] : mod.description;
				
				var strModCategory = "";
				if (mod.category != null) {
					for (var j = 0; j < mod.category.length; j++) {
						strModCategory += "<span>" + mod.category[j] +"</span>";
						if (j < mod.category.length - 1) {
							strModCategory += ", ";
						}
					}
				}
				
				var strForumLink = mod.forum ? "<div class='mod_link'>[ <a href='#' onClick='LaunchURL(\"" + mod.forum + "\")'><span class='LOC_forum'>forum</span></a> ]</div>" : "";
				var strInstallCount = "<img src='manager/img/download.png' style='position: absolute; margin-top:4px'> <div class='mod_count'>" + mod.downloads + "</div>";
				var strLikeCount = ""
				
				if (mod.likes != null) {
					if (mod.likes == -2) {
						strLikeCount = "<span id='" + id + "_like_count' class='mod_count'>Loading...</span>"
					}
					if (mod.likes >= 0) {
						strLikeCount = "<img src='manager/img/like.png' height='15' width='15' style='position: absolute; margin-top:4px; margin-left: 8px;'> <div class='mod_likes'>" + mod.likes + "</div>";
					}
				}

				var strDownloadText = "<span class='LOC_install'>install</span>";
				var strDownloadType = "install";
				var strNew = "";
				
				var dateNow = new Date();
				var dateUpdate = new Date(mod.date);
				if ((dateNow - dateUpdate)/(1000*60*60*24) < MOD_IS_NEW_PERIOD_DAYS) {
					strNew = "<span class='mod_new'>! <span class='LOC_NEW'>NEW</span></span>"
				} else {
					if (strOnlineModsFilter == "NEWLY_UPDATED") {
						strFiltered = "mod_filtered";
					}
				}
				
				var objInstalledMod = jsGetInstalledMod(id);
				if (objInstalledMod != null) {
					if (mod.date > objInstalledMod.date) {
						strDownloadText = "<span class='LOC_update'>update</span>";
						strDownloadType = "update";
					} else {
						strDownloadText = "<span class='LOC_reinstall'>reinstall</span>";
						strDownloadType = "reinstall";
						if (strOnlineModsFilter == "REQUIRES_UPDATE") {
							strFiltered = "mod_filtered";
						}
					}
					if (strOnlineModsFilter == "NOT_INSTALLED") {
						strFiltered = "mod_filtered";
					}
				} else {
					strDownloadLink = "<div class='mod_link'>[ <a href='#' onClick='Call jsInstallMod(\"" + mod.url + "\", \"" + id + "\")'><span class='LOC_install'>install</span></a> ]</div>";
					if (strOnlineModsFilter == "INSTALLED" || strOnlineModsFilter == "REQUIRES_UPDATE") {
						strFiltered = "mod_filtered";
					}
				}
				
				var strRequires = "";
				if (mod["requires"] != null) {
					strRequires = "<div class='mod_requires'><span class='LOC_REQUIRES'>REQUIRES</span>: ";
					for (var j = 0; j < mod["requires"].length; j++) {
						var strClass = "mod_requirement";
						if (jsGetInstalledMod(mod["requires"][j]) == null) {
							strClass = "mod_requirement_missing";
						}
						strRequires += "<span class='" + strClass + "'>" + mod["requires"][j] + "</span>";
						if (j < mod["requires"].length - 1) {
							strRequires += ", ";
						}
					}
					strRequires += "</div>";
				}
				
				var strDownloadLink = "<div class='mod_link mod_link_" + strDownloadType + "'>[ <a href='#' onClick='jsPreInstallMod(\"" + mod.url + "\", \"" + id + "\", {})'>" + strDownloadText + "</a> ]</div>";

				strHTML += "<div class='download_mod " + strFiltered + "'><div class='mod_background'></div>" + strIcon + "<div class='mod_container_online'><div class='mod_name'>" + strDisplayName + "</div><div class='mod_author'><span class='LOC_by'>by</span> " + mod.author + "</div><br/><div class='mod_version'><span class='LOC_Version'>Version</span>: " + mod.version + strBuild + strDate + "</div>" + strNew + strRequires + "<div class='mod_description'>" + strDescription + "</div><div class='mod_category'>" + strModCategory + "</div>" + strForumLink + strDownloadLink + strInstallCount + strLikeCount + "</div></div>"
			}
			
			document.getElementById("mod_download_inner").innerHTML = strHTML;
			
			jsApplyLocaleText();
		}

		function jsGenerateInstalledModsListHTML() {
			jsAddLogMessage("Generating Installed Mods List", 3);
			document.getElementById("mod_list").innerHTML = "";
						
			var intInstalledMods = objInstalledMods.length;
			for(var i = 0; i < intInstalledMods; i++) {
				var mod = objInstalledMods[i];
				var id = mod.id;
				if (id != PAMM_MOD_ID) {				
					var strLinkStartHTML = "";
					var strLinkEndHTML = "";
					var strInstalled = "";
					var strDownloadLink = "";
					
					var strDisplayName = mod["display_name_" + strCurrentLocale] ? mod["display_name_" + strCurrentLocale] : mod.display_name;
					
					var strForumLink = mod.forum ? "<div class='mod_link' onclick='window.event.cancelBubble = true'>[ <a href='#' onClick='LaunchURL(\"" + mod.forum + "\")'><span class='LOC_forum'>forum</span></a> ]</div>" : "";
					var strUninstallLink = "<div class='mod_link mod_link_uninstall' onclick='window.event.cancelBubble = true'>[ <a href='#' onClick='jsPreUninstallMod(\"" + id + "\")'><span class='LOC_uninstall'>uninstall</span></a> ]</div>";
					
					var strDate = mod.date ? " (" + mod.date + ")" : "";
					var strBuild = mod.build ? ", <span class='LOC_build'>build</span> " + mod.build : "";
									
					if (jsGetOnlineMod(id) != null && mod.date < jsGetOnlineMod(id).date) {
						jsAddLogMessage("Update available for installed mod '" + mod.display_name + "': " + jsGetOnlineMod(id).version + " (" + jsGetOnlineMod(id).date + ")", 3);
						strInstalled = "<div class='mod_update_available'><span class='LOC_UPDATE_AVAILABLE'>UPDATE AVAILABLE</span></div>";
						strDownloadLink = "<div class='mod_link'>[ <a href='#' onClick='jsPreInstallMod(\"" + jsGetOnlineMod(id).url + "\",\"" + id + "\", {})'><span class='LOC_update'>update</span></a> ]</div>";
					}
					
					var strRequires = "";
					if (mod["requires"] != null) {
						strRequires = "<div class='mod_requires'><span class='LOC_REQUIRES'>REQUIRES</span>: ";
						for (var j = 0; j < mod["requires"].length; j++) {
							var strClass = "mod_requirement";
							if (jsGetInstalledMod(mod["requires"][j]) == null) {
								strClass = "mod_requirement_missing";
							}
							strRequires += "<span class='" + strClass + "'>" + mod["requires"][j] + "</span>";
							if (j < mod["requires"].length - 1) {
								strRequires += ", ";
							}
						}
						strRequires += "</div>";
					}
					
					var strHTML = "<div class='mod'><div class='mod_background'></div><div class='mod_enable'><input type='checkbox' id='mod" + id + "' onClick=\"jsModEnabledToggle('" + id + "')\"/></div><div class='mod_container_install' onClick=\"jsToggleInstalledMod('" + id + "')\"><div class='mod_name'>" + strDisplayName + "</div><div class='mod_author'><span class='LOC_by'>by</span> " + mod.author + "</div><br/><div class='mod_version'><span class='LOC_Version'>Version</span>: " + mod.version + strBuild + strDate + "</div>" + strInstalled + "<br/>" + strRequires + strForumLink + strDownloadLink + strUninstallLink + "</div></div>";
					document.getElementById("mod_list").innerHTML += strHTML;
					document.getElementById("mod" + id).checked = mod.enabled;
				}
			}
			jsApplyLocaleText();
		}
		
		
		/* Mod Getter Functions */
		function jsGetOnlineMod(strModID) {
			for (var i = 0; i < objOnlineMods.length; i++) {
				if (objOnlineMods[i].id == strModID) {
					return objOnlineMods[i];
				}
			}
			return null;
		}
		
		function jsGetInstalledMod(strModID) {
			for (var i = 0; i < objInstalledMods.length; i++) {
				if (objInstalledMods[i].id == strModID) {
					return objInstalledMods[i];
				}
			}
			return null;
		}
		
		/* HTML Function Calls */
		function jsSetLanguage() {
			strCurrentLocale = document.getElementById("setting_language").value;
			objOptions["locale"] = strCurrentLocale;
			jsAddLogMessage("Setting locale to " + strCurrentLocale, 3);
			jsGenerateInstalledModsListHTML();
			jsGenerateOnlineModsListHTML();
			WriteOptionsJSON();
		}
		
		function jsToggleAvailableModsSort() {
			switch (strOnlineModsSort) {
				case "LAST_UPDATED":
					strOnlineModsSort = "TITLE";
					break;
				case "TITLE":
					strOnlineModsSort = "AUTHOR";
					break;
				case "AUTHOR":
					strOnlineModsSort = "BUILD";
					break;
				case "BUILD":
					strOnlineModsSort = "DOWNLOADS";
					break;
				case "DOWNLOADS":
					strOnlineModsSort = "LIKES";
					break;
				case "LIKES":
					strOnlineModsSort = "RANDOM";
					break;
				case "RANDOM":
					strOnlineModsSort = "LAST_UPDATED";
					break;
			}
			
			document.getElementById('sort_text').innerHTML = '<a href="#" onmousedown="jsToggleAvailableModsSort()"><span class="LOC_' + strOnlineModsSort + '">' + jsGetLocaleText(strOnlineModsSort, strCurrentLocale) + '</span></a>';
			
			if (strOnlineModsSort == "RANDOM") {
				document.getElementById('sort_text').innerHTML += ' <a href="#" onmousedown="jsGenerateOnlineModsListHTML()"><img src="manager/img/refresh.png" border=0></a>';
			}
			jsAddLogMessage("Available Mod sort by " + strOnlineModsSort + " applied", 4);
			objOptions["sort"] = strOnlineModsSort;
			WriteOptionsJSON();
			jsGenerateOnlineModsListHTML();
		}
		
		function jsToggleAvailableModsFilter() {
			switch (strOnlineModsFilter) {
				case "ALL":
					strOnlineModsFilter = "INSTALLED";
					break;
				case "INSTALLED":
					strOnlineModsFilter = "REQUIRES_UPDATE";
					break;
				case "REQUIRES_UPDATE":
					strOnlineModsFilter = "NEWLY_UPDATED";
					break;
				case "NEWLY_UPDATED":
					strOnlineModsFilter = "NOT_INSTALLED";
					break;
				case "NOT_INSTALLED":
					strOnlineModsFilter = "ALL";
					break;
			}
			document.getElementById('filter_text').innerHTML = "<span class='LOC_" + strOnlineModsFilter + "'>" + jsGetLocaleText(strOnlineModsFilter, strCurrentLocale) + "</span>";
			jsAddLogMessage("Available Mod filter " + strOnlineModsFilter + " applied", 4);
			objOptions["filter"] = strOnlineModsFilter;
			WriteOptionsJSON();
			jsGenerateOnlineModsListHTML();
		}
		
		function jsDisplayPanel(strPanelName) {
			document.getElementById('news').style.display = strPanelName == 'news' ? 'block' : 'none';
			document.getElementById('newsButton').style.color = strPanelName == 'news' ? '#F9F9F9' : '#888888';
			document.getElementById('installed').style.display = strPanelName == 'installed' ? 'block' : 'none';
			document.getElementById('modListButton').style.color = strPanelName == 'installed' ? '#F9F9F9' : '#888888';
			document.getElementById('download').style.display = strPanelName == 'download' ? 'block' : 'none';
			document.getElementById('modDownloadButton').style.color = strPanelName == 'download' ? '#F9F9F9' : '#888888';
			document.getElementById('log').style.display = strPanelName == 'log' ? 'block' : 'none';
			document.getElementById('log_icon').src = strPanelName == 'log' ? 'manager\\img\\log_select.png' : 'manager\\img\\log.png';
			document.getElementById('settings').style.display = strPanelName == 'settings' ? 'block' : 'none';
			document.getElementById('settings_icon').src = strPanelName == 'settings' ? 'manager\\img\\settings_select.png' : 'manager\\img\\settings.png';
			strCurrentPanel = strPanelName;
		}
			
		function jsPreInstallMod(strURL, strModID, objModsPreInstalled) {
			
			var objThisMod = jsGetOnlineMod(strModID);
			
			if (objThisMod["requires"] != null) {
				for (var i = 0; i < objThisMod["requires"].length; i++) {
					if (jsGetInstalledMod(objThisMod["requires"][i]) == null && objModsPreInstalled[objThisMod["requires"][i]] == null) {
						objModsPreInstalled[objThisMod["requires"][i]] = true;
						var strName = objThisMod["requires"][i];
						if (jsGetOnlineMod(objThisMod["requires"][i]) != null) {
							strName = jsGetOnlineMod(objThisMod["requires"][i]).display_name;
							var boolConfirm = confirm("Install required dependency '" + strName + "'?");
							if (boolConfirm == true) {
								objModsPreInstalled = jsPreInstallMod(jsGetOnlineMod(objThisMod["requires"][i]).url, objThisMod["requires"][i], objModsPreInstalled);
							}
						} else {
							alert("Warning: Required dependency '" + strName + "' unavailable");
						}
					}
				}
			}
			
			jsDelayedInstall(strURL, strModID);
			return objModsPreInstalled;
		}
		
		function jsDelayedInstall(strURL, strModID) {
			if (strModInstalling != "") {
				setTimeout(function() { 
					jsDelayedInstall(strURL, strModID);
				}, 500);
			} else {
				strModInstalling = strModID;
				InstallMod(strURL + "?r=" + Math.random(), strModID);
			}
		}
		
		
		function jsPreUninstallMod(strModID) {
			var boolConfirm = confirm("Are you sure you want to uninstall '" + jsGetInstalledMod(strModID).display_name + "'?");
			
			if (boolConfirm == true) {
				UninstallMod(strModID);
				jsRefresh(false, false);
			}
		}
		
		/* Download Functions */
		function jsCheckOnlineStatus() {
			var HTTP_OK = 200;
			jsAddLogMessage("Checking online status", 3);
			
			boolOnline = false;
			
			try {
				var oXMLHTTP = new ActiveXObject("MSXML2.XMLHTTP");
			} catch(e) {
				jsAddLogMessage("Critical Error: Could not create MSXML2.XMLHTTP ActiveX object: " + e.message, 1);
			}
			
			oXMLHTTP.open("GET", PAMM_ONLINE_TEST_URL + "?r=" + Math.random(), false);
			
			try {
				document.getElementById("downloading").style.display = "block";
				jsAddLogMessage("[Message ID: " + intMessageID + "] GET <span class='log_url' title='" + PAMM_ONLINE_TEST_URL + "'>&lt;url&gt;</span>", 4);
				oXMLHTTP.send();
			} catch(e) {
				jsAddLogMessage("Network Error: attempting to send request to " + PAMM_ONLINE_TEST_URL + "?r=" + Math.random() + ": " + e.message, 1);
			}
			intMessageID++;
			if (oXMLHTTP.readyState == 4) {
				if (oXMLHTTP.status == HTTP_OK) {
					boolOnline = true;
				}
			}
			document.getElementById("downloading").style.display = "none";
			jsAddLogMessage("Online status: " + (boolOnline == true ? "ONLINE" : "OFFLINE"), 2);
		}
		
		function jsDownload(strURL, strOutput, strOutputFilePath, successFunction) {
			try {
				var oXMLHTTP = new ActiveXObject("MSXML2.XMLHTTP");
			} catch(e) {
				jsAddLogMessage("Critical Error: Could not create MSXML2.XMLHTTP ActiveX object: " + e.message, 1);
			}
		
			oXMLHTTP.open("GET", strURL, true);
			
			var intCurrentMessageID = intMessageID;
			oXMLHTTP.onreadystatechange = function() { jsDownloadStateChange(oXMLHTTP, strURL, intCurrentMessageID, strOutput, strOutputFilePath, successFunction);};
			intMessageID++;
			
			try {
				document.getElementById("downloading").style.display = "block";
				jsAddLogMessage("[Message ID: " + intCurrentMessageID + "] GET <span class='log_url' title='" + strURL + "'>&lt;url&gt;</span>", 4);
				intDownloading++;
				oXMLHTTP.send();
			} catch(e) {
				jsAddLogMessage("Network Error: attempting to send request to " + strURL + ": " + e.message, 1);
			}

		}
		
		function jsDownloadStateChange(oXMLHTTP, strURL, intID, strOutput, strOutputFilePath, successFunction) {
			var HTTP_OK = 200;
			var HTTP_NOT_FOUND = 404;
			var adTypeBinary = 1;
			var adTypeText = 2;
			var adSaveCreateOverWrite = 2;
			var xmlReadyStates = ['Request not initialized', 'Server connection established', 'Request received ', 'Processing request', 'Request finished and response is ready'];
			
			//jsAddLogMessage("[Message ID: " + intID + "] " + xmlReadyStates[oXMLHTTP.readyState], 4);
			if (oXMLHTTP.readyState == 4) {
			
				try {
					var oStream = new ActiveXObject("ADODB.Stream");
				} catch(e) {
					jsAddLogMessage("Critical Error: Could not create ADODB.Stream ActiveX object", 1);
				}
			
				intDownloading--;
				if (intDownloading == 0) {
					document.getElementById("downloading").style.display = "none";
				}
				jsAddLogMessage("[Message ID: " + intID + "] HTTP " + oXMLHTTP.statusText + " (" + oXMLHTTP.status + ") <span class='log_url' title='" + strURL + "'>&lt;url&gt;</span>", 4);
				if (oXMLHTTP.status == HTTP_OK) {
					if (strOutput == "string") {
						oStream.Type = adTypeBinary;
						oStream.Open ();
						oStream.Write (oXMLHTTP.responseBody);
						oStream.Position = 0;
						oStream.Type = adTypeText;
						oStream.CharSet = "utf-8"; //"shift_jis";
						var strText = oStream.ReadText (oStream.Size)
						oStream.Close();
						if (successFunction != null) {
							eval(successFunction);
						}
					}
					if (strOutput == "file") {
						
						oStream.Open();
						oStream.Type = adTypeBinary;
						oStream.Write(oXMLHTTP.ResponseBody);

						try {
							oStream.SaveToFile(strOutputFilePath, adSaveCreateOverWrite);
						} catch(e) {
							jsAddLogMessage("Write Error: Could not save file '" + strOutputFilePath + "': " + e.message, 1);
						}
						
						oStream.Close();
						if (successFunction != null) {
							eval(successFunction);
						}
					}
					if (strOutput == null) {
						if (successFunction != null) {
							eval(successFunction);
						}
					}
				} else if (oXMLHTTP.status == HTTP_NOT_FOUND) {
				} else {
				}
				oStream = null;
			} else {
			}
			oXMLHTTP = null;
		}
		
		/* Refresh & Update Functions */
		function jsUpdateFiles() {
			if (boolAutoWrite == true) {
				WriteModsJSON();
				WriteUIModListJS();
				WriterModListJS();
			}
		}
		
		function jsRefresh(boolShowLoading, boolDownloadData) {
			if (boolShowLoading == true) {
				document.getElementById("news_data").innerHTML = "<div class=\"loading\">Loading...</div>";
				document.getElementById("mod_list").innerHTML = "<div class=\"loading\">Loading...</div>";
				document.getElementById("mod_download_inner").innerHTML = "<div class=\"loading\">Loading...</div>";
			}
			
			if (boolDownloadData == true) {
				jsCheckOnlineStatus();
			}
			
			if (boolOnline == false) {
				document.getElementById("news_data").innerHTML = "<div class=\"loading\">Mod Manager is offline</div>";	
				document.getElementById("mod_download_inner").innerHTML = "<div class=\"loading\">Mod Manager is offline</div>";
			}
			
			jsAddLogMessage("Refreshing Data", 2);
			
			if (boolDownloadData == true) {
				jsDownloadNews();
				jsDownloadOnlineMods();
			}
			FindInstalledMods();
			objInstalledMods.sort(sort_by('display_name', true, null));
			jsGenerateInstalledModsListHTML();
		}
		
		/* Settings Functions */
		function jsToggleDebugMode() {
			jsSetLogLevel(document.getElementById("setting_debug").checked ? 4 : objOptions["verbose"] ? 3 : 2);
			objOptions["debug"] = document.getElementById("setting_debug").checked;
			WriteOptionsJSON();
		}
		
		function jsToggleVerboseMode() {
			jsSetLogLevel(document.getElementById("setting_debug").checked ? 4 : document.getElementById("setting_verbose").checked ? 3 : 2);
			objOptions["verbose"] = document.getElementById("setting_verbose").checked;
			WriteOptionsJSON();
		}
		
		function jsSetDefaultTab() {
			objOptions["tab"] = document.getElementById("setting_defaultTab").value;
			jsAddLogMessage("Setting default tab to " + objOptions["tab"], 3);
			WriteOptionsJSON();
		}
		
		/* Log Functions */
		function jsAddLogMessage(strText, intLevel) {
			var strType = "INFO";
			if (intLevel == 1) { 
				strType = "ERROR"; 
			}
			if (intLevel == 4) { 
				strType = "DEBUG"; 
			}
			
			var objCurrentTime = new Date();
			var strHours = objCurrentTime.getHours() < 10 ? "0" + objCurrentTime.getHours() : objCurrentTime.getHours();
			var strMinutes = objCurrentTime.getMinutes() < 10 ? "0" + objCurrentTime.getMinutes() : objCurrentTime.getMinutes();
			var strSeconds = objCurrentTime.getSeconds() < 10 ? "0" + objCurrentTime.getSeconds() : objCurrentTime.getSeconds();

			document.getElementById("log_data").innerHTML += '<div id="log_' + intLogNumber + '" class="log_entry' + (intLevel == 4 ? "_debug" : "") + ' log_level' + intLevel + '"><div class="log_time">' + strHours + ':' + strMinutes + ':' + strSeconds + '</div><div class="log_type">[' + strType + ']</div> ' + strText + '</div>';
			
			if (intLevel <= intLogLevel) { 
				$("#log_" + intLogNumber).css({display: "block"});
			}

			document.getElementById("log_data").scrollTop = document.getElementById("log_data").scrollHeight;
			intLogNumber++;
		}
		
		function jsSetLogLevel(intLevel) {
			var strLevel = "INFO";
			if (intLevel == 1) { 
				strLevel = "ERROR"; 
			}
			if (intLevel == 3) { 
				strLevel = "INFO - VERBOSE"; 
			}
			if (intLevel == 4) { 
				strLevel = "DEBUG"; 
			}
			if (intLevel != intLogLevel) {
				jsAddLogMessage("Setting log level to " + intLevel + " (" + strLevel + ")", 3);
				intLogLevel = intLevel;
				$(".log_level3").css({display: intLogLevel >= 3 ? "block" : "none"});
				$(".log_level4").css({display: intLogLevel >= 4 ? "block" : "none"});
			}
		}
		
		/* Downloads & Asynch Callbacks */
		function jsDownloadNewPAMMinstaller(strPath) {
			if (boolOnline == true) {
				jsAddLogMessage("Downloading new PAMM installer", 2);
				jsDownload(objPAMMVersionData.url, "file", strPath, "InstallPAMM('" + objPAMMVersionData.filename + "')");
			}
		}
				
		function jsDownloadOnlineMods(strURL) {
			if (boolOnline == true) {
				jsAddLogMessage("Downloading available mods list", 2);
				jsDownload(ONLINE_MODS_LIST_URL + "?r=" + Math.random(), "string", null, "jsDownloadOnlineMods_asynch(strText)");
			}
		}
		
		function jsDownloadOnlineMods_asynch(strResult) {
			try {
				objOnlineMods = [];
				var objModData = JSON.parse(strResult);
				for (var id in objModData) {
					objModData[id]["id"] = id;
					objModData[id]["likes"] = -2;
					objOnlineMods.push(objModData[id]);
				}
				
				jsDownloadOnlineModDownloadCount();
			} catch (e) {
				jsAddLogMessage("Error loading online mod data: " + e.message, 1);
			}
		}
		
		function jsDownloadOnlineModDownloadCount() {
			if (boolOnline == true) {
				jsAddLogMessage("Getting availailable mod download counts", 2);
				jsDownload(ONLINE_MODS_DOWNLOAD_COUNT_URL + "?r=" + Math.random(), "string", null, "jsDownloadOnlineModDownloadCount_asynch(strText)");
			}
		}
		
		function jsDownloadOnlineModDownloadCount_asynch(strResult) {
			try {
				var objOnlineModsDownloadCount = JSON.parse(strResult);
				for (var i = 0; i < objOnlineMods.length; i++) {
					objOnlineMods[i]["downloads"] = objOnlineModsDownloadCount[objOnlineMods[i].id] ? objOnlineModsDownloadCount[objOnlineMods[i].id] : 0;
				}
				
				jsGenerateOnlineModsListHTML();
				jsGenerateInstalledModsListHTML();
				jsDownloadOnlineModLikeCount();
				jsUpdateFiles();
			} catch (e) {
				jsAddLogMessage("Error loading online mod download count data: " + e.message, 1);
			}
		}
		
		function jsDownloadOnlineModLikeCount() {
			jsAddLogMessage("Getting mod likes", 2);
			for (var i = 0; i < objOnlineMods.length; i++) {
				
			
				if (objOnlineMods[i]["forum"] != null) {
					if (objOnlineMods[i]["forum"].indexOf("forums.uberent.com") > -1) {
						intLikeCountRemaining++;
						jsDownload(objOnlineMods[i]["forum"], "string", null, "jsDownloadOnlineModLikeCount_asynch('" + objOnlineMods[i].id + "' , strText)");
					} else {
						jsAddLogMessage("Invalid forum link for mod '" + objOnlineMods[i]["display_name"] + "' (Not from forums.uberent.com)", 3);
						objOnlineMods[i]["likes"] = -1;
					}
				} else {
					jsAddLogMessage("Missing forum link for mod '" + objOnlineMods[i]["display_name"] + "'", 3);
					objOnlineMods[i]["likes"] = -1;
				}
			}
			
			var objTimer = setInterval(function() {
				if(intLikeCountRemaining == 0) {
					jsGenerateOnlineModsListHTML();
					clearInterval(objTimer);
				}
			}, 100);
		}
		
		function jsDownloadOnlineModLikeCount_asynch(intModID, strResult) {
			var objOnlineMod = jsGetOnlineMod(intModID)
			try {
				var objNodes = $(strResult).find(".message").first().find(".LikeText");
				var intLikes = objNodes.children(".username").length;
				if  (objNodes.children(".OverlayTrigger").length > 0) {
					var strText = objNodes.children(".OverlayTrigger").text();
					intLikes += parseInt(strText);
				}
				objOnlineMod["likes"] = intLikes;
				jsAddLogMessage("Like count for mod '" + objOnlineMod["display_name"] + "': " + intLikes, 3);
			} catch (e) {
				jsAddLogMessage("Error loading online mod like count data: " + e.message, 1);
				objOnlineMod["likes"] = -1;
			}
			intLikeCountRemaining--;
		}
		
		function jsDownloadPAMMversion() {
			if (boolOnline == true) {
				jsAddLogMessage("Checking for PAMM updates", 2);
				jsDownload(PAMM_VERSION_DATA_URL + "?r=" + Math.random(), "string", null, "jsDownloadPAMMversion_asynch(strText)");
			}
		}
		
		function jsDownloadPAMMversion_asynch(strResult) {
			try {
				objPAMMVersionData = JSON.parse(strResult);
				var dateLatestPAMM = new Date(objPAMMVersionData.date);
				jsAddLogMessage("Latest version of PAMM: " + objPAMMVersionData.version + " (" + objPAMMVersionData.date + ")", 2);
				if (new Date(datePAMM) < dateLatestPAMM) {
					jsAddLogMessage("New version of PAMM available: " + objPAMMVersionData.version + " (" + objPAMMVersionData.date + ")", 2);
					UpdatePAMM(objPAMMVersionData.version, objPAMMVersionData.filename);
				} else {
					jsAddLogMessage("Latest version of PAMM installed", 2);
				}
			} catch (e) {
				jsAddLogMessage("Error loading PAMM version data: " + e.message, 1);
			}
		}
		
		function jsDownloadNews() {
			if (boolOnline == true) {
				jsAddLogMessage("Downloading news", 2);
				jsDownload(NEWS_URL + "?r=" + Math.random(), "string", null, "jsDownloadNews_asynch(strText)");
			}
		}
		
		function jsDownloadNews_asynch(strResult) {
			document.getElementById("news_data").innerHTML = strResult;
		}
	</script>
		
	<!-- GUI related functions -->
	<script language="VBScript">
		Dim objShell
		Dim objFSO
		Dim objApp
		
		Dim strModsDirectoryPath
		Dim strPAMMCacheDirectoryPath
	
		Call Initialise()
			
		'Initialisation of variables
		Sub Initialise()
			Set objApp = CreateObject("Shell.Application")
			Set objFSO = CreateObject("Scripting.FileSystemObject")
			Set objShell = CreateObject("WScript.Shell")
			
			objShell.currentDirectory = Left(window.location.pathname, InStrRev(window.location.pathname, "\") - 1)
			
			strModsDirectoryPath = objShell.expandenvironmentstrings("%LOCALAPPDATA%") & "\Uber Entertainment\Planetary Annihilation\mods"
			strPAMMCacheDirectoryPath = objShell.expandenvironmentstrings("%LOCALAPPDATA%") & "\Uber Entertainment\Planetary Annihilation\pamm_cache"
			
			Call CreateFolderIfNotExists(objShell.expandenvironmentstrings("%LOCALAPPDATA%") & "\Uber Entertainment\")
			Call CreateFolderIfNotExists(objShell.expandenvironmentstrings("%LOCALAPPDATA%") & "\Uber Entertainment\Planetary Annihilation\")
			Call CreateFolderIfNotExists(objShell.expandenvironmentstrings("%LOCALAPPDATA%") & "\Uber Entertainment\Planetary Annihilation\mods\")
			Call CreateFolderIfNotExists(objShell.expandenvironmentstrings("%LOCALAPPDATA%") & "\Uber Entertainment\Planetary Annihilation\mods\rPAMM\")
			Call CreateFolderIfNotExists(objShell.expandenvironmentstrings("%LOCALAPPDATA%") & "\Uber Entertainment\Planetary Annihilation\mods\rPAMM\ui\")
			Call CreateFolderIfNotExists(objShell.expandenvironmentstrings("%LOCALAPPDATA%") & "\Uber Entertainment\Planetary Annihilation\mods\rPAMM\ui\mods\")
			Call CreateFolderIfNotExists(objShell.expandenvironmentstrings("%LOCALAPPDATA%") & "\Uber Entertainment\Planetary Annihilation\pamm_cache\")
			
			Set objPAMMFile = objFSO.GetFile("manager\modinfo.json")
			Call objPAMMFile.Copy(strModsDirectoryPath & "\rPAMM\modinfo.json", true)
		End Sub
		
		Sub CreateFolderIfNotExists(strPath)
			If Not(objFSO.FolderExists(strPath)) Then
				objFSO.CreateFolder(strPath)
			End If
		End Sub
		
		'Launches a URL in the user's browser of choice
		Sub LaunchURL(strURL)
			Call jsAddLogMessage("Launching URL: " & strURL, 3)
			objShell.Run(strURL)
		End Sub
		
		'Closes the PA Mod Manager
		Sub ClosePAMM()
			Call Self.Close()
		End Sub
				
		'Searches the PA Installation for modlist.json files
		Sub FindInstalledMods()
			Dim objFolder
			Dim objFile
			Dim objFiles
			Dim intMods
			Dim objStream

			Set objStream = CreateObject("ADODB.Stream")
			objStream.CharSet = "utf-8"			
			
			
			
			Set objFolder = objFSO.GetFolder(strModsDirectoryPath)

			Call jsClearInstalledModData()
			
			intMods = 0
			For Each objSubFolder in objFolder.SubFolders
				Set objFiles = objSubFolder.Files
				For Each objFile in objFiles
					If objFile.Name = "modinfo.json" Then
						Call objStream.open()
						
						Call jsAddLogMessage("Found installed mod: " & objSubFolder.name, 3)
						Call objStream.LoadFromFile(objSubFolder.path & "\" & objFile.name)
						
						Call jsLoadInstalledModData(objSubFolder.name, objStream.ReadText())
						
						Call objStream.close()
						intMods = intMods + 1
					End If
				Next
			Next
			Call jsAddLogMessage("Found " & intMods & " installed mods", 2)
			
			Call jsUpdateFiles()
		End Sub
		
		'Loads in options data
		Sub LoadOptions()
			Dim objStream

			Set objStream = CreateObject("ADODB.Stream")
			objStream.CharSet = "utf-8"	
			
			If objFSO.FileExists(strPAMMCacheDirectoryPath & "\" & PAMM_OPTIONS_FILENAME) = True Then
				Call objStream.open()
				Call jsAddLogMessage("Options file found, loading settings", 3)
				
				Call objStream.LoadFromFile(strPAMMCacheDirectoryPath & "\" & PAMM_OPTIONS_FILENAME)
				Call jsLoadOptionsData(objStream.ReadText())
				
				Call objStream.close()
			Else
				Call jsAddLogMessage("Options file not found, using defaults", 3)
				Call jsLoadOptionsData("{}")
			End If
		End Sub
		
		'Writes Options file
		Sub WriteOptionsJSON()
			Dim objStream
			Const adModeReadWrite = 3
			Const adTypeText = 2
			Const adLF = 10
		
			Set objStream = CreateObject("ADODB.Stream")
			objStream.CharSet = "utf-8"	
			objStream.Type = adTypeText
			objStream.Mode = adModeReadWrite
			objStream.LineSeparator = adLF
			
			Call objStream.open()
				
			Call objStream.WriteText(jsGetOptionsDataString())
			Call WriteUTF8WithoutBOM(objStream, strPAMMCacheDirectoryPath & "\" & PAMM_OPTIONS_FILENAME)
			
			Call jsAddLogMessage("Writing options file", 4)
			
			Call objStream.flush()
			Call objStream.close()
		End Sub
		
		'Writes data to ui_mod_list.js
		Sub WriteUIModListJS()
			Dim objStream
			Const adModeReadWrite = 3
			Const adTypeText = 2
			Const adLF = 10
		
			Set objStream = CreateObject("ADODB.Stream")
			objStream.CharSet = "utf-8"	
			objStream.Type = adTypeText
			objStream.Mode = adModeReadWrite
			objStream.LineSeparator = adLF
			
			Call objStream.open()
			
			Call objStream.WriteText("var global_mod_list = " & jsGetUIModListGlobalDataString() & ";" & NEW_LINE & NEW_LINE)
			Call objStream.WriteText("var scene_mod_list = " & jsGetUIModListSceneDataString())
			Call WriteUTF8WithoutBOM(objStream, strModsDirectoryPath & "\rPAMM\ui\mods\ui_mod_list.js")
			
			Call jsAddLogMessage("Writing ui_mod_list.js", 4)
			
			Call objStream.flush()
			Call objStream.close()
		End Sub
		
		'Writes data to mods_list.json
		Sub WriterModListJS()
			Dim objStream
			Const adModeReadWrite = 3
			Const adTypeText = 2
			Const adLF = 10
		
			Set objStream = CreateObject("ADODB.Stream")
			objStream.CharSet = "utf-8"	
			objStream.Type = adTypeText
			objStream.Mode = adModeReadWrite
			objStream.LineSeparator = adLF
			
			Call objStream.open()
			
			Call jsAddLogMessage("Writing mods_list.json", 4)
			Call objStream.WriteText(jsGetInstalledModListDataString())
			
			Call WriteUTF8WithoutBOM(objStream, strModsDirectoryPath & "\rPAMM\ui\mods\mods_list.json")
			
			Call objStream.flush()
			Call objStream.close()
		End Sub
		
		'Writes data to mods.json
		Sub WriteModsJSON()
			Dim objStream
			Const adModeReadWrite = 3
			Const adTypeText = 2
			Const adLF = 10
		
			Set objStream = CreateObject("ADODB.Stream")
			objStream.CharSet = "utf-8"	
			objStream.Type = adTypeText
			objStream.Mode = adModeReadWrite
			objStream.LineSeparator = adLF
			
			Call objStream.open()
			
			Call jsAddLogMessage("Writing mods.json", 4)
			Call objStream.WriteText(jsGetModsJSONDataString())
			
			Call WriteUTF8WithoutBOM(objStream, strModsDirectoryPath & "\mods.json")
			
			Call objStream.flush()
			Call objStream.close()
		End Sub
		
		'Writes the contents of a mods modinfo.json
		Sub WriteModinfoJSON(strModID)
			Dim objStream
			Const adModeReadWrite = 3
			Const adTypeText = 2
			Const adLF = 10
		
			Set objStream = CreateObject("ADODB.Stream")
			objStream.CharSet = "utf-8"	
			objStream.Type = adTypeText
			objStream.Mode = adModeReadWrite
			objStream.LineSeparator = adLF
		
			If objFSO.FileExists(strModsDirectoryPath & "\" & strModID & "\modinfo.json") Then
			
				Call objStream.open()
				
				Call jsAddLogMessage("Writing modsinfo.json for mod '" & strModID & "'", 4)
				Call objStream.WriteText(jsGetInstalledModDataString(strModID))
			
				Call WriteUTF8WithoutBOM(objStream, strModsDirectoryPath & "\" & strModID & "\modinfo.json")
				
				Call objStream.flush()
				Call objStream.close()
			End If
		End Sub
		
		Sub WriteUTF8WithoutBOM(objStream, strSavePath)
			Dim objBinaryStream
			Const adSaveCreateOverWrite = 2
			Const adModeReadWrite = 3
			Const adTypeBinary = 1
			
			Set objBinaryStream = CreateObject("ADODB.Stream")
			objBinaryStream.Type = adTypeBinary
			objBinaryStream.Mode = adModeReadWrite
			objBinaryStream.Open
			
			objStream.position = 3
			objStream.CopyTo objBinaryStream
	
			objBinaryStream.SaveToFile strSavePath, adSaveCreateOverWrite
			
			Call objBinaryStream.flush()
			Call objBinaryStream.close()
		End Sub
		
		'Downloads and installs a mod
		Sub InstallMod(strURL, strModID)
			Dim strModFileName
			
			'Extract File Name from URL
			strModFileName = Right(strURL, Len(strURL) - inStrRev(strURL, "/"))
			strModFileName = Left(strModFileName, inStr(strModFileName, "?")-1)
			
			Call Randomize()
			Call RemoveFileFromCache(strModFileName)
			
			Call jsDownload(MANAGE_URL & "?download=" & strModID & "&r=" & rnd(), null, null, null)
			
			Call jsAddLogMessage("Downloading mod '" & strModID & "'", 3)
			Call jsDownload(strURL, "file", strPAMMCacheDirectoryPath & "\" & strModFileName, "UninstallMod('" & strModID & "'); ExtractMod('" & strModFileName & "', '" & strModID & "')")
		End Sub
		
		'Extracts a Mod Zip file to the mods folder
		Sub ExtractMod(strFileName, strModID)
			Dim objFiles
			
			'Check for existence of mod zip file
			If objFSO.FileExists(strPAMMCacheDirectoryPath & "\" & strFileName) = True Then
			
				'Get all files in zip
				set objFiles = objApp.NameSpace(strPAMMCacheDirectoryPath & "\" & strFileName).items

				'Extract to mods directory
				Call jsAddLogMessage("Installing mod '" & strModID & "'", 3)
				objApp.NameSpace(strModsDirectoryPath).CopyHere(objFiles)
				Call jsRefresh(false, false)
				Call jsSetModEnabledStatus(strModID, true)
			End If
			
			If strModInstalling <> "" Then
				strModInstalling = ""
			End If
		End Sub
		
		'Removes a specified file from the cache, if it exists
		Sub RemoveFileFromCache(strFileName)
		
			'Check for and remove existing file if present
			If objFSO.FileExists(strPAMMCacheDirectoryPath & "\" & strFileName) = True Then
				On Error Resume Next
				Err.Clear
				
				Call jsAddLogMessage("Clearing cached file '" & strFileName & "'", 4)
				
				'Can throw errors
				objFSO.deleteFile strPAMMCacheDirectoryPath & "\" & strFileName, true
				
				'An error occurred
				If Err.Number <> 0 Then
					Call DisplayError("Cache Error: Unable to remove existing file '" & strFileName & "'." & vbnewline & Err.Description)
					Err.Clear
				End If
				
				On Error Goto 0
			End If
		End Sub
		
		'Uninstalls a mod
		Sub UninstallMod(strModID)
			If objFSO.FolderExists(strModsDirectoryPath & "\" & strModID) = True Then
				On Error Resume Next
				Err.Clear
				
				Call jsAddLogMessage("Uninstalling mod '" & strModID & "'", 2)
				
				'Can throw errors
				objFSO.deleteFolder strModsDirectoryPath & "\" & strModID, true
				
				'An error occurred
				If Err.Number <> 0 Then
					Call DisplayError("File Error: Unable to remove folder '" & strModID & "'." & vbnewline & Err.Description)
					Err.Clear
				End If
				
				On Error Goto 0
				
				Call jsRemoveInstalledMod(strModID)
			End If
		End Sub

		'Determines if a new version of PAMM is available, and offers to install it
		Sub UpdatePAMM(strVersion, strFilename)
			Const vbOKCancel = 1
			Const vbOK = 1
			Dim intResult
			
			intResult = msgbox("Version " & strVersion & " of PA Mod Manager is now available. Click OK to download and install.", vbOKCancel)
				
			if intResult = vbOK Then
				Call jsDownloadNewPAMMinstaller(strPAMMCacheDirectoryPath & "\" & strFilename)
			End If
		End Sub
			
		'Runs installer for new PAMM version
		Sub InstallPAMM(strFilename)
			objApp.ShellExecute strPAMMCacheDirectoryPath & "\" & strFilename, "", "", "runas", 1
			Call ClosePAMM()
		End Sub
		
		'Returns whether PA.exe exists at the specified location
		Function CheckPAPresent(strPath)
			CheckPAPresent = false
			On Error Resume Next
			Err.Clear
			
			CheckPAPresent = objFSO.FileExists(strPath)
						
			On Error Goto 0
		End Function
		
		'Launches PA
		Sub LaunchPA()
			objApp.ShellExecute jsGetOption("pa_path"), "", "", "", ""
			Call ClosePAMM()
		End Sub

	</script>

	<body onLoad="jsOnLoad()">
		<div id="container">
			<div id="installed" class="tab">
				<div id="mod_list_background" class="tab_background"></div>
				<div id="mod_list" class="tab_content">
				</div>
			</div>
			<div id="download" class="tab">
				<div id="mod_download_background" class="tab_background"></div>
				<div class="mod_download_options">
					<div class="filter_options"><span class="LOC_SHOW">SHOW</span>: <br/><a href="#" id="filter_text" onmousedown="jsToggleAvailableModsFilter()"><span class="LOC_ALL">ALL</span></a></div><div class="sort_options"><span class="LOC_SORT">SORT</span>: <br/><span id="sort_text"><a href="#" onmousedown="jsToggleAvailableModsSort()"><span class="LOC_LAST_UPDATED">LAST UPDATED</span></a></span></div>
				</div>
				<div id="mod_download" class="tab_content">
					<div id="mod_download_inner">
					</div>
				</div>
			</div>
			<div id="news" class="tab">
				<div id="news_background" class="tab_background"></div>
				<div id="news_data" class="tab_content">
					
				</div>
			</div>
			<div id="log" class="tab">
				<div id="log_background" class="tab_background"></div>
				<div id="log_data" class="tab_content">
					<div class="log_heading"><span class="LOC_LOG">LOG</span></div>
				</div>
			</div>
			<div id="settings" class="tab">
				<div id="settings_background" class="tab_background"></div>
				<div id="settings_data" class="tab_content">
					<div class = "settings_heading"><span class="LOC_SETTINGS">SETTINGS</span></div>
					<div class="settings_items">
						<table class="settings_table">
							<tr>
								<td><span class="setting_heading"><span class="LOC_Language">Language</span>:</span></td>
								<td>
									<select id="setting_language" onChange="jsSetLanguage()">
										<option value="en">ENGLISH</option>
										<option value="fr">FRANAIS</option>
										<option value="nl">NEDERLANDS</option>
										<option value="de">DEUTSCH</option>
									</select>
								</td>
							</tr>
							<tr>
								<td><span class="setting_heading"><span class="LOC_Default_Tab">Default Tab</span>:</span></td>
								<td>
									<select id="setting_defaultTab" onChange="jsSetDefaultTab()">
										<option value="news" class="LOC_NEWS">NEWS</option>
										<option value="installed" class="LOC_INSTALLED_MODS">INSTALLED MODS</option>
										<option value="download" class="LOC_AVAILABLE_MODS">AVAILABLE MODS</option>
									</select>
								</td>
							</tr>
							<tr>
								<td><span class="setting_heading"><span class="LOC_Verbose_Log">Verbose Log</span>:</span></td>
								<td><input id="setting_verbose" type="checkbox" onClick="jsToggleVerboseMode()"/></td>
							</tr>
							<tr>
								<td><span class="setting_heading"><span class="LOC_Debug_Mode">Debug Mode</span>:</span></td>
								<td><input id="setting_debug" type="checkbox" onClick="jsToggleDebugMode()"/></td>
							</tr>
							<tr>
								<td colspan="2">&nbsp;</td>
							</tr>
							<tr>
								<td colspan="2">
									<span class="setting_heading"><span class="LOC_PA_Install_Location">PA Install Location</span>:</span><br/>
									<input id="setting_installLocation" type="text" disabled="true" class="textInput"/>
								</td>
							</tr>
						</table>
					</div>
				</div>
			</div>
			<img src="manager\img\img_pa_logo_alpha.png">
			<h1><span class="LOC_MOD_MANAGER">MOD MANAGER</span></h1>
			
			<div class="button"><a href="#" id="newsButton" onclick="jsDisplayPanel('news')"><span class="LOC_NEWS">NEWS</span></a></div>
			<div class="button"><a href="#" id="modListButton" onclick="jsDisplayPanel('installed')"><span class="LOC_INSTALLED_MODS">INSTALLED MODS</span></a></div>
			<div class="button"><a href="#" id="modDownloadButton" onclick="jsDisplayPanel('download')"><span class="LOC_AVAILABLE_MODS">AVAILABLE MODS</span></a></div>
			<div class="button"><a href="#" id="logButton" onclick="jsDisplayPanel('log')"><img id="log_icon" src="manager\img\log.png"></a></div>
			<div class="button"><a href="#" id="settingsButton" onclick="jsDisplayPanel('settings')"><img id="settings_icon" src="manager\img\settings.png"></a></div>
			<div class="buttons">
				<input id="btnLaunch" type="button" value="Launch PA" class="LOC_Launch_PA" onClick="LaunchPA()"/>
				<input type="button" value="Refresh" class="LOC_Refresh" onClick="jsRefresh(true, true)"/>
				<input type="button" value="Exit" class="LOC_Exit" onClick="ClosePAMM()"/>
				<div class="credits"><a href="https://forums.uberent.com/threads/rel-ui-mod-manager.50726/"><span class="LOC_Version">Version</span> 3.1.2</a>, <span class="LOC_by">by</span> Raevn</div>
			</div>
			<div id="downloading">
				<img src="manager/img/loading.gif">
			</div>
		</div>
	</body>
	
	<script type="text/javascript">
		function jsOnLoad() {
			jsApplyLocaleText();
			document.getElementById("btnLaunch").disabled = true;
			LoadOptions();
			setTimeout(function() {
				jsRefresh(true, true);
				if (boolOnline == true) {
					jsDownloadPAMMversion();
				}
			}, 500);
		}
	</script>
</html>
